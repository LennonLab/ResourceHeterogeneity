---
title: "Resource Heterogeneity Structures Microbial Communities"
author: "Mario E. Muscarella"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
   - \usepackage{graphics}
   - \usepackage{booktabs}
output: 
  pdf_document:
    fig_caption: true
---

# Introduction
What is this project about?
What are they hypotheses?

## Initial Setup
```{r, results='hide', message=FALSE, warning=FALSE}
rm(list=ls())
getwd()
setwd("~/GitHub/ResourceHeterogeneity/analyses")

# Import Tools and Standard Functions
source("../bin/MothurTools.R")
source("../bin/CommonFunctions.R")

# Save Standard Plot Settings
opar <- par(no.readonly = TRUE)  # Saves plot defaults

# Load Required Packages
require("png"); require("grid");require("vegan"); require("igraph")
require("picante");require("bioDist");require("gplots")
#require("xtable");require("phyloseq");require("car"); require("ade4");require("bioDist")
require("colorspace")

```

# Load Data & Minor Processing
## Lake Nutrient Concentrations
```{r}
nuts <- read.csv(file = "../data/HMWF_Nutrients.txt", header = T)
chl <- read.delim(file = "../data/ChlorophyllA.txt", header = T)
chl <- chl[order(chl$Year, chl$Lake), ]
```

## Load DOM Profiles
```{r}
# Define Inputs
# Resource = raw site-by-resource matrix
resource.pos <- "../data/SpecAbundAvePos.csv"
resource.neg <- "../data/SpecAbundAveNeg.csv"
design.in <- "../data/design.txt"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)

# Import Resources
res.in <- read.csv(resource.neg, header=T, row.names=1)
rownames(res.in) <- c("Ann", "blank", "CanyonChemo", "Canyon", "CanyonHypo",
                      "CanyonI", "CanyonII", "CanyonIII", "CanyonIV", "Howe",
                      "Ives", "Jordan", "Lily", "Mountain", "Pony", "Rush",
                      "SecondPine", "UpperPine")

blank <- unlist(res.in["blank", ])
res.hmwf <- res.in[-c(which(rownames(res.in) %in% c("blank", "CanyonChemo", 
                          "CanyonHypo", "CanyonI", "CanyonII",
                          "CanyonIII", "CanyonIV", "Jordan"))), ]

# Remove Blank Peaks
for (i in 1:dim(res.hmwf)[1]){
  res.hmwf[i, ] <- res.hmwf[i, ] - blank * 1.1
}

# Remove Peaks Under Height of 50
res.hmwf[res.hmwf < 50] <- 0

# Remove Zero Sum Columns
res.hmwf <- res.hmwf[,colSums(res.hmwf) > 0]

# Data Transformations
# Reorder Sites
res <- res.hmwf[order(rownames(res.hmwf)), ]

# Sequencing Coverage
coverage <- rowSums(res)
resources <- dim(res)[2]

# Make Relative Abundence Matrices
resREL <- res
for(i in 1:dim(res)[1]){
  resREL[i,] <- res[i,]/sum(res[i,])
}

# Log Transform Relative Resource Abundance
resREL.log <- decostand(resREL, method="log")
```

## Load Bacterial Community Data
```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU
design.in <- "../data/design.txt"
shared <- "../data/HMWF.bac.final.shared"
taxon  <- "../data/HMWF.bac.final.0.03.taxonomy"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)

# Import Shared Files
OTUs.in <- read.otu(shared = shared, cutoff = "0.03")    # 97% Similarity

# Import Taxonomy
OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Data Transformations
# Reorder Site
OTUs.hmwf <- OTUs.in[rownames(design), ]

# Remove OTUs with less than two occurences across all sites
# OTUs <- OTUs.hmwf[, which(colSums(OTUs.hmwf) >= 2)]
OTUs <- OTUs.hmwf[, colSums((OTUs.hmwf > 0) * 1)  >= 2 | colSums(OTUs.hmwf) >= 10]

# Sequencing Coverage
coverage <- rowSums(OTUs)
bacteria <- dim(OTUs)[2]

# Good's Coverage
goods.c <- goods(OTUs)

# Make Presence Absence Matrix
OTUsPA <- (OTUs > 0) * 1

# Make Relative Abundence Matrices
OTUsREL <- OTUs
for(i in 1:dim(OTUs)[1]){
  OTUsREL[i,] <- OTUs[i,]/sum(OTUs[i,])
}

# Log Transform Relative Abundances
OTUsREL.log <- decostand(OTUs, method="log")
```

# Statistical Description of Resources
```{r}
range(nuts$DOC);range(nuts$TN);range(nuts$TP)

CV(nuts$DOC)
CV(nuts$TN)
CV(nuts$TP)
CV(chl$ChlA)

cor.test(nuts$DOC, nuts$TN)
cor.test(nuts$TN, nuts$TP)
cor.test(nuts$DOC, nuts$TP)

cor.test(nuts$DOC, chl$ChlA)


# Principal Components Axis
nuts.pca <- princomp(nuts[, 4:5])
summary(nuts.pca)
nuts.axis <- nuts.pca$scores[,1]

PCA.res <- princomp(cbind(scale(nuts$DOC), scale(nuts$TN), scale(nuts$TP)))
summary(PCA.res)
     
PCA.res1 <- scale(PCA.res$scores[,1])

cor.test(PCA.res1, chl$ChlA)
```

# Statistical Description of DOM Structural Diversity 
```{r}
# Observed Richness
S.res <- rowSums((res > 0) * 1)

# Simpson's Evenness
res.simpsE <- round(apply(res, 1, SimpE), 3)

# Shannon's Diversity
res.shan <- round(vegan::diversity(res, index = "shannon"), 2)

# Combine Alpha Diversity
res.div <- as.data.frame(cbind(S.res, res.simpsE, res.shan))

# Summary Stats
range(res.div$S.res);range(res.div$res.shan);range(res.div$res.simpsE)
CV(res.div$S.res);CV(res.div$res.shan);CV(res.div$res.simpsE)
```

# DOM Compositional Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.res <- vegdist(resREL, method = "bray")
# hmwf.bray.res <- vegdist(resREL.log, method = "bray")

dis.mean <- mean(hmwf.bray.res)

# Principal Coordinates Analysis
pcoa.res <- cmdscale(hmwf.bray.res, eig = TRUE, k = 3) 
explainvar1.res <- round(pcoa.res$eig[1] / sum(pcoa.res$eig), 3) * 100
explainvar2.res <- round(pcoa.res$eig[2] / sum(pcoa.res$eig), 3) * 100
explainvar3.res <- round(pcoa.res$eig[3] / sum(pcoa.res$eig), 3) * 100
sum.eig.res <- sum(explainvar1.res, explainvar2.res, explainvar3.res)

# DOM Scores
dom.scores <- t(cor(pcoa.res$points,res))
dom.scores <- as.matrix(dom.scores)[,1:2]
dom.scores <- dom.scores[abs(dom.scores[,1]) > 0.7 | abs(dom.scores[,2]) > 0.7, ]

write.table(round(dom.scores, 3), file = "../data/HMWF_DOM.txt", sep = "\t", quote = F,
            col.names = NA)
```


# Statistical Description of Bacterial Structural Diversity
```{r}
# Observed Richness
S.obs <- rowSums((OTUs > 0) * 1)

# Simpson's Evenness
simpsE <- round(apply(OTUs, 1, SimpE), 3)

# Shannon's Diversity
shan <- vegan::diversity(OTUs, index = "shannon")

# Rarefied Richness
S.rar <- round(rarefy(OTUs, min(rowSums(OTUs))), 0)

alpha.div <- cbind(design, S.obs, simpsE, shan, S.rar)
alpha.div <- alpha.div[order(alpha.div$Lake, alpha.div$Year, alpha.div$Molecule), ]

# Summary Stats
range(alpha.div$S.rar);range(alpha.div$simpsE)
CV(alpha.div$S.rar);CV(alpha.div$simpsE)
CV(alpha.div$S.rar[alpha.div$Lake != "Pony" & alpha.div$Lake != "Lily"])
range(alpha.div$S.rar[alpha.div$Lake != "Pony" & alpha.div$Lake != "Lily"])
```

## Bacterial Compositional Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.REL <- vegdist(OTUsREL, method = "bray")
hmwf.bray.REL.D <- vegdist(OTUsREL[design$Molecule == "DNA", ], method = "bray")
hmwf.bray.REL.R <- vegdist(OTUsREL[design$Molecule == "RNA", ], method = "bray")

dis.mean <- mean(hmwf.bray.REL)
dis.meanD <- mean(hmwf.bray.REL.D)
dis.meanR <- mean(hmwf.bray.REL.R)

adonis(hmwf.bray.REL ~ design$Molecule)

# Principal Coordinates Analysis 
pcoa.rel <- cmdscale(hmwf.bray.REL, eig = TRUE, k = 3) 
explainvar1.rel <- round(pcoa.rel$eig[1] / sum(pcoa.rel$eig), 3) * 100
explainvar2.rel <- round(pcoa.rel$eig[2] / sum(pcoa.rel$eig), 3) * 100
explainvar3.rel <- round(pcoa.rel$eig[3] / sum(pcoa.rel$eig), 3) * 100
sum.eig.rel <- sum(explainvar1.rel, explainvar2.rel, explainvar3.rel)

# OTU Scores
otu.scores <- t(cor(pcoa.rel$points,OTUsREL))
otu.scores <- as.matrix(otu.scores)[,1:2]
otu.scores <- otu.scores[abs(otu.scores[,1]) > 0.7|abs(otu.scores[,2]) > 0.7,]
```

# Resource Heterogeneity and Community Diversity
## Structural Relationships
```{r}
# Organize Data
nuts$PCA <- as.numeric(PCA.res1 + 1)
dat1D <- data.frame(alpha.div[alpha.div$Molecule == "DNA", ], nuts[order(nuts$Site), ])
dat1R <- data.frame(alpha.div[alpha.div$Molecule == "RNA", ], nuts[order(nuts$Site), ])
dat2D <- data.frame(dat1D[dat1D$Year == "2012", ], res.div[order(rownames(res.div)), ])
dat2R <- data.frame(dat1R[dat1R$Year == "2012", ], res.div[order(rownames(res.div)), ])
dat2  <- data.frame(rbind(dat2D, dat2R))
dat2  <- dat2[order(dat2$Lake), ]

dat2D$PCA[dat2D$Lake == "Pony"] <- dat2D$PCA[dat2D$Lake == "Pony"] - 2
dat2D$S.rar[dat2D$Lake == "Pony"] <- dat2D$S.rar[dat2D$Lake == "Pony"] - 800

dat2R$PCA[dat2D$Lake == "Pony"] <- dat2R$PCA[dat2R$Lake == "Pony"] - 2
dat2R$S.rar[dat2D$Lake == "Pony"] <- dat2R$S.rar[dat2R$Lake == "Pony"] - 800

# Resource Concentration and Diversity (Total)
mod1 <- lm(S.rar ~ PCA, data = dat2D[dat2D$Lake != "Pony" & dat2D$Lake != "Lily", ])
mod2 <- lm(simpsE ~ PCA, data = dat2D[dat2D$Lake != "Pony", ])
summary(mod1);summary(mod2)

# Resource Heterogeneity and Divesity (Total)
mod3 <- lm(S.rar ~ S.res, data = dat2D[dat2D$Lake != "Pony", ])
mod4 <- lm(simpsE ~ S.res, data = dat2D[dat2D$Lake != "Pony", ])
summary(mod3);summary(mod4)

# Resource Concentration and Diversity (Active)
mod1 <- lm(S.rar ~ PCA, data = dat2R[dat2R$Lake != "Pony" & dat2R$Lake != "Lily", ])
mod2 <- lm(simpsE ~ PCA, data = dat2R[dat2R$Lake != "Pony" & dat2R$Lake != "Lily", ])
summary(mod1);summary(mod2)

# Resource Heterogeneity and Divesity (Active)
mod3 <- lm(S.rar ~ S.res, data = dat2R[dat2R$Lake != "Pony" & dat2R$Lake != "Lily", ])
mod4 <- lm(simpsE ~ S.res, data = dat2R[dat2R$Lake != "Pony", ])
summary(mod3);summary(mod4)

# Same Tests with Active Community
mod5 <- lm(S.rar ~ PCA, data = dat1R[dat1R$Lake != "Pony", ])
mod6 <- lm(simpsE ~ PCA, data = dat1R[dat1R$Lake != "Pony", ])
mod7 <- lm(S.rar ~ S.res, data = dat2R[dat2R$Lake != "Pony", ])
mod8 <- lm(simpsE ~ S.res, data = dat2R[dat2R$Lake != "Pony", ])
summary(mod8)

# Stats
mod1.p <- round(summary(mod1)$coefficients[2,4], 3)
mod2.p <- round(summary(mod2)$coefficients[2,4], 3)
mod3.p <- round(summary(mod3)$coefficients[2,4], 3)
mod4.p <- round(summary(mod4)$coefficients[2,4], 3)

# Prediction Frames
pred.frame1 <- data.frame(PCA = seq(0, 2.1, 0.1))
pred.frame2 <- data.frame(S.res = seq(526,572,2))

# Correlation Test
cor.test(~ S.res + PCA, data = dat2R[dat2R$Lake != "Pony", ])
```

## Structural Relationship Plots
```{r, results = "hide"}
# Confidence Hulls
add.hull <- function(model = "", pred.frame = ""){
  CI.U <- predict(model, interval = "c", newdata=pred.frame)[, "upr"]
  CI.L <- predict(model, interval = "c", newdata=pred.frame)[, "lwr"]
  pred.frame2 <- unlist(pred.frame)
  X.Vec <- c(pred.frame2, tail(pred.frame2, 1), rev(pred.frame2),
               head(pred.frame2, 1))
  Y.Vec <- c(CI.U, tail(CI.L, 1), rev(CI.L), head(CI.U,1))
  polygon(X.Vec, Y.Vec, col = "gray90", border = NA)
}

png(filename="../figures/Figure1.png",
    width = 1600, height = 1600, res = 96*2, bg = "white")
par(opar)

layout(matrix(1:4, nrow = 2, byrow = F))
par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(5, 5.5, 0, 0) + 0.1)

# Resource Concentration vs Species Richness
plot(dat2R$S.rar ~ dat2R$PCA, 
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 2.1), ylim = c(400, 1300), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod1, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod1, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2R$S.rar ~ dat2R$PCA,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topleft", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
# mtext("Nutrients", side = 1, line = 3, cex = 1.5)
mtext("Species Richness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(0, 2))
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)
text(1.7, 1245, "Pony")
text(1.73, 1070, "Lily")

# Resource Concentration vs Species Evenness
plot(dat2R$simpsE ~ dat2R$PCA,
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 2.1), ylim = c(0, 0.06), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod2, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod2, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2R$simpsE ~ dat2R$PCA,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1.5, inset = 0.01)
mtext("Resource Concentration", side = 1, line = 3.5, cex = 1.5)
mtext("Species Evenness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = T, at = c(0, 0.5, 1, 1.5, 2), cex.axis = 1.5)
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

# Resource Richness vs Species Richness
plot(dat2R$S.rar ~ dat2R$S.res,
     xlab = "", ylab = "", type = "n", axes = F,
     xlim = c(525, 572), ylim = c(400, 1300), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod3, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod3, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2R$S.rar ~ dat2R$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1.5, inset = 0.01)
# mtext("DOM Richness", side = 1, line = 3, cex = 1.5)
# mtext("Species Richness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, labels = F, las = 1)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)

# Resource Richness vs Species Eveness
plot(dat2R$simpsE ~ dat2R$S.res,
     xlab = "", ylab = "", type = "n", axes = F,
     xlim = c(525, 572), ylim = c(0, 0.06), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod4, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod4, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2R$simpsE ~ dat2R$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topleft", legend = bquote(italic(P) == .(mod4.p)), 
       bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
mtext("DOM Richness", side = 1, line = 3.5, cex = 1.5)
# mtext("Species Evenness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, las = 1, at = c(seq(520, 570, 10)), cex.axis = 1.5)
axis(2, lwd = 2, labels = F, las = 1, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/Figure1.png")
grid.raster(img)
```

## Compositional Relationships (dbRDA)
```{r, warning = FALSE}
# Define Environmental Gradients
## Resource Concentration
## dat1D; dat1R; dat2D; dat2R

## DOM Composition
## pcoa.res$points[, 1]; pcoa.res$points[, 2]; pcoa.res$points[, 3]

## Community Composition
# Define DNA and RNA Community
OTUsREL.D <- OTUsREL[design$Molecule == "DNA" , ]
OTUsREL.R <- OTUsREL[design$Molecule == "RNA" , ]
OTUsREL.D2012 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" , ]
OTUsREL.R2012 <- OTUsREL[design$Molecule == "RNA" & design$Year == "2012" , ]

# Calculate Bray-Curtis Distances for Bacteria
Bray.REL.D <- vegdist(decostand(OTUsREL.D, "log"), "bray")
Bray.REL.R <- vegdist(decostand(OTUsREL.R, "log"), "bray")
Bray.REL.D2012 <- vegdist(decostand(OTUsREL.D2012, "log"), "bray")
Bray.REL.R2012 <- vegdist(decostand(OTUsREL.R2012, "log"), "bray")

# Resource Concentration dbRDA 
dbRDA.D <- capscale(Bray.REL.D ~ dat1D$PCA, comm = OTUsREL.D, add = T)
dbRDA.R <- capscale(Bray.REL.R ~ dat1R$PCA, comm = OTUsREL.R, add = T)
bdRDA.D2012 <- capscale(Bray.REL.D2012 ~ dat2D$PCA, comm = OTUsREL.D2012, add = T)
dbRDA.R2012 <- capscale(Bray.REL.R2012 ~ dat2R$PCA, comm = OTUsREL.R2012, add = T)

anova(bdRDA.D2012, permutations = how(nperm=9999))
RsquareAdj(bdRDA.D2012)
anova(dbRDA.R2012, permutations = how(nperm=9999))
RsquareAdj(dbRDA.R2012)

# With Pony and Lily Removed (DNA)
dat2D.2 <- dat2D[dat2D$Lake != "Pony" & dat2D$Lake != "Lily", ]
OTUsREL.D.2 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" & 
                         design$Lake != "Pony" & design$Lake != "Lily", ]
Bray.REL.D.2 <- vegdist(OTUsREL.D.2, "bray")
dbRDA.D.2 <- capscale(Bray.REL.D.2 ~ dat2D.2$PCA, comm = OTUsREL.D.2, add = T)

anova(dbRDA.D.2, permutations = how(nperm=9999))
RsquareAdj(dbRDA.D.2)

# With Pony and Lily Removed (RNA)
dat2R.2 <- dat2R[dat2R$Lake != "Pony" & dat2R$Lake != "Lily", ]
OTUsREL.R.2 <- OTUsREL[design$Molecule == "RNA" & design$Year == "2012" & 
                         design$Lake != "Pony" & design$Lake != "Lily", ]
Bray.REL.R.2 <- vegdist(OTUsREL.R.2, "bray")
dbRDA.R.2 <- capscale(Bray.REL.R.2 ~ dat2R.2$PCA, comm = OTUsREL.R.2, add = T)

anova(dbRDA.R.2, permutations = how(nperm=9999))
RsquareAdj(dbRDA.R.2)

# DOM Diversity dbRDA
Bray.RES <- vegdist(decostand(resREL, "log"), "bray")
pcoa.RES <- cmdscale(Bray.RES, k = 3, eig = T)
dbRDA.D.DOM <- capscale(Bray.REL.D2012 ~ pcoa.RES$points, 
                                comm = OTUsREL.D2012, add = T)
dbRDA.R.DOM <- capscale(Bray.REL.R2012 ~ pcoa.RES$points,
                                comm = OTUsREL.R2012, add = T)

anova(dbRDA.D.DOM, permutations = how(nperm=9999))
RsquareAdj(dbRDA.D.DOM)
anova(dbRDA.R.DOM, permutations = how(nperm=9999))
RsquareAdj(dbRDA.R.DOM)

# With Pony and Lily Removed (DNA)
## Subset OTUs
OTUsREL.D.2 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" & 
                       design$Lake != "Pony" & design$Lake != "Lily", ]
rownames(OTUsREL.D.2) <- gsub("2012_DNA", "", rownames(OTUsREL.D.2))
Bray.REL.D2012.2 <- vegdist(decostand(OTUsREL.D.2, "log"), method = "bray")

## Subset Resources
resREL2 <- resREL[rownames(resREL) != "Pony" & rownames(resREL) != "Lily", ]
Bray.RES2 <- vegdist(resREL2, method = "bray")
pcoa.RES2 <- cmdscale(Bray.RES2, eig = TRUE, k = 2)

## dbRDA Analysis
dbRDA.D.DOM.2 <- capscale(Bray.REL.D2012.2 ~ pcoa.RES2$points, add = T)
anova(dbRDA.D.DOM.2, permutations = how(nperm=9999), model = "direct")
RsquareAdj(dbRDA.D.DOM.2)

# With Pony and Lily Removed (RNA)
## Subset OTUs
OTUsREL.R.2 <- OTUsREL[design$Molecule == "RNA" & design$Year == "2012" & 
                       design$Lake != "Pony" & design$Lake != "Lily", ]
rownames(OTUsREL.R.2) <- gsub("2012_RNA", "", rownames(OTUsREL.R.2))
Bray.REL.R2012.2 <- vegdist(decostand(OTUsREL.R.2, "log"), method = "bray")

## Subset Resources
resREL2 <- resREL[rownames(resREL) != "Pony" & rownames(resREL) != "Lily", ]
Bray.RES2 <- vegdist(decostand(resREL2, "log"), method = "bray") 
pcoa.RES2 <- cmdscale(Bray.RES2, eig = TRUE, k = 2) 

## dbRDA Analysis
dbRDA.R.DOM.2 <- capscale(Bray.REL.R2012.2 ~ pcoa.RES2$points, add = T) 
anova(dbRDA.R.DOM.2, permutations = how(nperm=9999), model = "direct")
RsquareAdj(dbRDA.R.DOM.2)

dbRDA.R.DOM.2 <- capscale(Bray.REL.R2012.2 ~ pcoa.RES2$points[,2], add = T)
anova(dbRDA.R.DOM.2, permutations = how(nperm=9999), model = "direct")
RsquareAdj(dbRDA.R.DOM.2)

# Resource Concentration/Composition Correlations
cor.test(dat2R$PCA, pcoa.res$points[,1])
cor.test(dat2R$PCA, pcoa.res$points[,2])
cor.test(dat2R$PCA, pcoa.res$points[,3])


```

# Bacterial PCoA Plot with Env Vectors
```{r, results='hide'}
# PCoA of Active Community
# bray.BAC <- vegdist(decostand(OTUsREL, "log"), "bray")
pcoa.BAC <- cmdscale(Bray.REL.R2012, k = 2, eig = T)
explainvar1 <- round(pcoa.BAC$eig[1] / sum(pcoa.BAC$eig), 3) * 100
explainvar2 <- round(pcoa.BAC$eig[2] / sum(pcoa.BAC$eig), 3) * 100

# PCoA of Resoruces
bray.RES <- vegdist(decostand(resREL, "log"), "bray")
pcoa.RES <- cmdscale(bray.RES, k = 3, eig = T)

# Resource Concentrations
cons.RES <- dat2R$PCA

# Initial Plot as PNG
png(filename="../figures/Figure2.png",
    width = 1300, height = 900, res = 96*2, bg = "white")

# Define Plot Parameters
par(opar)
par(mar = c(4, 5, 1, 1) + 0.5)

# Initiate Plot 1
plot(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], 
     ylim = c(-0.4, 0.4), xlim = c(-0.4, 0.6), 
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     #xlab = "", ylab = "", xaxt = "n", yaxt = "n",
     pch = 22, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1, 
     axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
  
# Add Points & Labels
points(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], pch = 22, 
       cex = 2, bg = "gray", lwd = 2)

# Resource Concentration Vector
res.con <- envfit(pcoa.BAC, cons.RES)
con.arrows <- res.con[[1]]$arrows * 0.3
arrows(0, 0, con.arrows[, 1], con.arrows[, 2], col = "gray10", length = 0.1, lwd = 2)
text(con.arrows[, 1] * 1.2, con.arrows[, 2] * 1.2, "Conc.", col = "black", cex = 1)

# DOM Composition Vectors
res.com <- envfit(pcoa.BAC, pcoa.RES$points[,1:2])
com.arrows <- res.com[[1]]$arrows * 0.3
arrows(0, 0, com.arrows[1, 1], com.arrows[1, 2], col = "gray60", length = 0.1, lwd = 2)
arrows(0, 0, com.arrows[2, 1], com.arrows[2, 2], col = "gray60", length = 0.1, lwd = 2)
text(com.arrows[1, 1] * 1.15, com.arrows[1, 2] * 1.15, "DOM 1", col = "black", cex = 1)
text(com.arrows[2, 1] * 1.22, com.arrows[2, 2] + 0.03, "DOM 2", col = "black", 
     cex = 1, pos = 1)

text(0.45, -0.05, "Pony", col = "black", cex = 0.8)
text(0.58, 0.12, "Lily", col = "black", cex = 0.8)

legend("bottomright", c("Resource Concentration Model", "Resource Composition Model"),
       lwd = 2, col = c("gray10", "gray60", "gray60"), bty = "n")

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
# ```

# ```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/Figure2.png")
grid.raster(img)
```

# Consumer Resource Specialization
```{r}
# Subset OTUs for most dominant
OTUsREL.2012 <- OTUsREL[grep("2012_RNA", rownames(OTUsREL)),]
OTUsREL.dom2012 <- OTUsREL.2012[,which(colSums(as.matrix(OTUsREL.2012)) > 0.01)]

#OTUsREL.dom2012 <- OTUsREL.dom2012[,order(colSums(as.matrix(OTUsREL.dom2012)),
#                                         decreasing = T)[1:120]]

# Subset Resources for most dominant
resREL.dom <- resREL[,which(colSums(as.matrix(resREL)) > 0.01)]
resREL.dom <- resREL.dom[,order(colSums(as.matrix(resREL.dom)), decreasing = T)[1:100]]

# Subset Resoruce for most influential
resREL.sc <- t(cor(pcoa.RES$points,resREL))
resREL.sc <- as.matrix(resREL.sc)[,1:3]
resREL.sc <- resREL.sc[abs(resREL.sc[,1]) > 0.7 | abs(resREL.sc[,2]) > 0.7  | 
                         abs(resREL.sc[,3]) > 0.7, ]
resREL.inf <- resREL[, which(colnames(resREL) %in% rownames(resREL.sc))]

# 
# # Mege OTUs and Resources Matrices
# ConRes1 <- cbind(as.matrix(OTUsREL.dom2012), as.matrix(resREL.dom))
# ConRes2 <- cbind(as.matrix(resREL.dom), as.matrix(OTUsREL.dom2012))
# ConRes <- rbind(ConRes1, ConRes2)

# Calculate 1 - Spearman Correlation Coefficients: Spearman Distance
# spear.ConRes <- spearman.dist(t(as.matrix(ConRes)), abs = FALSE, diag = T, upper = T)

# Define Function
spear.matrix <- function(mat1 = "", mat2 = "", dim1 = "", dim2 = ""){
  mat.temp <- matrix(NA, dim1, dim2)
  row.names(mat.temp) <- colnames(mat1)
  colnames(mat.temp) <- colnames(mat2)
  mat.temp <- cor(mat1, mat2, method = "spearman")
  return(mat.temp)
}

dim1 <- dim(OTUsREL.dom2012)[2]
dim2 <- dim(resREL.inf)[2]

# Calculate Consumer Resource Correlations
spear.ConRes <- spear.matrix(mat1 = OTUsREL.dom2012, mat2 = resREL.inf, dim1, dim2)

# Isolate Relavent Interactions
spear.ConRes2 <- spear.ConRes
spear.ConRes2[which(spear.ConRes < 0.7 & spear.ConRes > -0.7)] <- 0
spear.ConRes3 <- spear.ConRes2

# Summary
str(spear.ConRes3)
sum(spear.ConRes3 < -0.7)
sum(spear.ConRes3 > 0.7)
pos.cor.ConRes <- which(spear.ConRes3 > 0.7)
neg.cor.ConRes <- which(spear.ConRes3 < -0.7)

# Significance Test
sig.test.neg <- vector("list", 1000)
sig.test.pos <- vector("list", 1000)
for (i in 1:1000) {
  # Two IndepSwap Runs
  testA <- randomizeMatrix(as.matrix(OTUsREL.dom2012), null.model = "independentswap")
  testB <- randomizeMatrix(as.matrix(resREL.inf), null.model = "independentswap")
  # Co-Occurence Analysis
  spear.ConRes.test <- spear.matrix(testA, testB, dim1, dim2)
  spear.ConRes2.test <- spear.ConRes.test
  spear.ConRes2.test[which(spear.ConRes.test < 0.7 & spear.ConRes.test > -0.7)] <- 0
  spear.ConRes3.test <- as.matrix(spear.ConRes2.test)
  sig.test.neg[[i]] <- which(spear.ConRes3.test < -0.7)
  sig.test.pos[[i]] <- which(spear.ConRes3.test > 0.7)
}

# False Negatives
false.neg <- which((table(unlist(sig.test.neg)) / 1000) > 0.05)
false.pos <- which((table(unlist(sig.test.pos)) / 1000) > 0.05)
weak.neg <- which((table(unlist(sig.test.neg)) / 1000) > 0.05 & 
                    (table(unlist(sig.test.neg)) / 1000) < 0.1)
weak.pos <- which((table(unlist(sig.test.pos)) / 1000) > 0.05 & 
                    (table(unlist(sig.test.pos)) / 1000) < 0.1)

length(setdiff(neg.cor.ConRes, c(false.neg, weak.neg)))
length(setdiff(pos.cor.ConRes, c(false.pos, weak.neg)))
sum(length(setdiff(neg.cor.ConRes, c(false.neg, weak.neg))), 
    length(setdiff(pos.cor.ConRes, c(false.pos, weak.neg)))) / 10000

# Remove Non Significant Interactions and Define Weak Interactions
spear.ConRes4 <- spear.ConRes3
bad.ints.neg <- sort(false.neg)
bad.ints.pos <- sort(false.pos)
for (i in 1:length(bad.ints.neg)){
  if (spear.ConRes4[bad.ints.neg[i]] < 0){
    spear.ConRes4[bad.ints.neg[i]] <- 0
  } else {}
}
for (i in 1:length(bad.ints.pos)){
  if (spear.ConRes4[bad.ints.pos[i]] > 0){
    spear.ConRes4[bad.ints.pos[i]] <- 0
  } else {}
}
weak.ints.neg <- sort(weak.neg)
weak.ints.pos <- sort(weak.pos)
for (i in 1:length(weak.ints.neg)){
  if (spear.ConRes4[weak.ints.neg[i]] < 0){
    spear.ConRes4[weak.ints.neg[i]] <- 0
  } else {}
}
for (i in 1:length(weak.ints.pos)){
  if (spear.ConRes4[weak.ints.pos[i]] > 0){
    spear.ConRes4[weak.ints.pos[i]] <- 0
  } else {}
}

# Remove Zero Sum Col and Rows
spear.ConRes5 <- spear.ConRes4[which(apply(spear.ConRes4, 1, min) < 0), 
                               which(apply(spear.ConRes4, 2, min) < 0)]

# Summary
str(spear.ConRes5)
dim(spear.ConRes5)
sum(spear.ConRes5 < -0.7)
sum(spear.ConRes5 > 0.7)
percent.total <- (sum(spear.ConRes5 < -0.7) + sum(spear.ConRes5 > 0.7)) / 
  (dim(spear.ConRes5)[1] * dim(spear.ConRes5)[2])
pos.cor.ConRes <- which(spear.ConRes5 > 0.7)
neg.cor.ConRes <- which(spear.ConRes5 < -0.7)
sum(colSums(spear.ConRes5) != 0) / dim(spear.ConRes)[2]
sum(rowSums(spear.ConRes5) != 0) / dim(spear.ConRes)[1]
sum(pos.cor.ConRes != 0)
sum(neg.cor.ConRes != 0)

# Custome Color Palette
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))
jet.colors.W <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                   "white", "white", "white", "white",
                                   "yellow", "#FF7F00", "red", "#7F0000"))
```

# Interaction Plot
```{r, results='hide'}
png(filename="../figures/Figure3A.png",
    width = 1800, height = 1800, res = 96*2, bg = "white")
par(opar)
ConRes.matrix <- as.matrix(spear.ConRes5)
rownames(ConRes.matrix) <- gsub("Otu000", "OTU",rownames(ConRes.matrix))
res.order <- order(colSums(ConRes.matrix <=  -0.5), decreasing = T)
cons.order <- order(rowSums(ConRes.matrix <= -0.5), decreasing = T)
heatmap.2(ConRes.matrix[cons.order, res.order], col = jet.colors.W, Rowv = F, Colv = F,
          dendrogram = "none", na.rm = F, na.color = "white", trace = "none", 
          density.info = "none", key.xlab = "Interaction", key.title = "", 
          key.par=list(cex = 0.75, cex.lab = 1.5, mar = c(5.5, 2, 5.5, 2)), 
          cexCol = 0.4, cexRow = 0.4, main = "", lhei = c(2, 8), margins = c(5, 5))
mtext("Resource Availability", side = 3, line = 2, cex = 2, adj = 0.60)
mtext("Available", side = 3, line = 0.8, cex = 1, adj = 0.2,  padj = 1)
mtext("Restrictive", side = 3, line = 0.8, cex = 1, adj = 1, padj = 1)
mtext("Consumer Strategy", side = 2, line = -1, cex = 2, adj = 0.325)
mtext("Generalist", side = 2, line = -5, cex = 1, adj = 1, las = 1, at = 0.90)
mtext("Specialist", side = 2, line = -5, cex = 1, adj = 1, las = 1, at = -0.12, xpd = T)
arrows(x0 = 0.33, y0 = 1.015, x1 = 0.83, y1 = 1.015, length = 0.1, angle = 45, lwd = 3, xpd = T)
arrows(x0 = 0.1, y0 = 0.85, x1 = 0.1, y1 = -0.08, length = 0.1, angle = 45, lwd = 3, xpd = T)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
# ```

# ```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Interaction Heatmap"}
img <- readPNG("../figures/Figure3A.png")
grid.raster(img)
```

# Example Responders
```{r, results='hide'}
png(filename="../figures/Figure3B.png",
    width = 1600, height = 900, res = 96*2)
par(opar)
# Example Taxa
examples <- ConRes.matrix[cons.order, res.order]
abundancesR <- OTUsREL.dom2012[design$Molecule == "RNA" & design$Year == "2012", ]
colnames(abundancesR) <- gsub("Otu000", "OTU",colnames(abundancesR))
rownames(abundancesR) <- gsub("2012_RNA", "", rownames(abundancesR))

# Set Plot Parameters 
layout(matrix(c(1:2), 1, 2))
par(mar = c(1, 2, 0, 0) + 0.5, oma = c(4, 3, 0.5, 0.5))

# Negative Example

OTU.neg <- abundancesR[, which(colnames(abundancesR) == "OTU020")]
DOM.neg <- resREL.dom[, which(colnames(resREL.dom) == "C94")]
plot(OTU.neg * 100, DOM.neg * 1000, pch = 22, bg = "gray", cex = 2, lwd = 2,
     xlim = c(0, 3.2), ylim = c(0.8, 4.3), las = 1, cex.lab = 1.5, 
     xlab = "", ylab = "", axes = F)
cor(OTU.neg, DOM.neg, method = "spearman")
lines(stats::lowess(DOM.neg * 1000 ~ OTU.neg * 100), lwd = 4, lty = 2)
axis(side=1, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 0.8, las = 1)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = T, cex.axis = 0.8, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
box(lwd = 2)

# Positive Example
OTU.pos <- abundancesR[, which(colnames(abundancesR) == "OTU067")]
DOM.pos <- resREL.inf[, which(colnames(resREL.inf) == "C789")]
plot(OTU.pos * 100, DOM.pos * 1000, pch = 22, bg = "gray", cex = 2, lwd = 2,
     xlim = c(0, 1.1), ylim = c(0, 1.15), las = 1, cex.lab = 1.5,
     xlab = "", ylab = "", axes = F)
cor(OTU.pos, DOM.pos, method = "spearman")
lines(stats::lowess(DOM.pos * 1000 ~ OTU.pos * 100), lwd = 4, lty = 2)
axis(side=1, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 0.8, las = 1)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = T, cex.axis = 0.8, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
box(lwd = 2)

mtext("Species Abundance (%)", 1, line = 2, cex = 1.25, outer = T)
mtext("Resource Abundance (\u2030)", 2, line = 1, cex = 1.25, outer = T)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Interaction Heatmap"}
img <- readPNG("../figures/Figure3B.png")
grid.raster(img)
```


# Generalist:Specialist Ratio
```{r}
specialists <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) <= 2]
generalists <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) >= 3]

length(generalists)

abundancesD <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012", ]
colnames(abundancesD) <- gsub("Otu000", "OTU",colnames(abundancesD))
rownames(abundancesD) <- gsub("2012_DNA", "", rownames(abundancesD))

abundancesR <- OTUsREL[design$Molecule == "RNA" & design$Year == "2012", ]
colnames(abundancesR) <- gsub("Otu000", "OTU",colnames(abundancesR))
rownames(abundancesR) <- gsub("2012_RNA", "", rownames(abundancesR))

spec.matrix <- matrix(NA, nrow = 10, ncol = 6)
colnames(spec.matrix) <- c("Total.Rel.Gen", "Active.Rel.Gen", "Total.Num.Gen", 
                           "Total.Rel.Spe", "Active.Rel.Spe", "Total.Num.Spe")
rownames(spec.matrix) <- rownames(abundancesD)

for (i in 1:(dim(spec.matrix)[1])){
  temp.gensT <- abundancesD[i, colnames(abundancesD) %in% generalists]
  temp.gensA <- abundancesR[i, colnames(abundancesR) %in% generalists]
  temp.specT <- abundancesD[i, colnames(abundancesD) %in% specialists]
  temp.specA <- abundancesR[i, colnames(abundancesR) %in% specialists]
  spec.matrix[i,1] <- round(sum(temp.gensT), 3)
  spec.matrix[i,2] <- round(sum(temp.gensA), 3)
  spec.matrix[i,3] <- sum(temp.gensT > 0)
  spec.matrix[i,4] <- round(sum(temp.specT), 3)
  spec.matrix[i,5] <- round(sum(temp.specA), 3)
  spec.matrix[i,6] <- sum(temp.specA > 0)
}


t.test(spec.matrix[, 2], spec.matrix[,4], var.equal = T)


#```


# Generalist:Specialists Ratio Plot
#```{r, results='hide'}
png(filename="../figures/Figure4.png",
    width = 1600, height = 1600, res = 96*2)
par(opar)
layout(matrix(c(1,2), 2, 1))
par(mar = c(5, 5, 0, 0) + 0.5, oma = c(0.5, 1, 1, 1))

labs <- c("Ann", "Canyon", "Howe", "Ives", "Lily", "Mountain", "Pony", "Rush",
         "Second\nPine","Upper\nPine")


# Initiate Plot
plot(spec.matrix[,2], type = "n", 
     xlim = c(0.75, 10.25), ylim = c(0, 0.8),
     xaxt="n", yaxt="n", xlab = "", ylab = "")
points(seq(0.9, 9.9, 1), spec.matrix[,2], pch = 22, cex = 2,
       bg = "gray80", lwd = 2)
#points(seq(1.1, 10.1, 1), spec.matrix[,2], pch = 24, cex = 2,
#       bg = "cornflowerblue", lwd = 2)
points(seq(0.9, 9.9, 1), spec.matrix[,5], pch = 24, cex = 2,
       bg = "gray80", lwd = 2)
#points(seq(1.1, 10.1, 1), spec.matrix[,5], pch = 24, cex = 2,
#       bg = "wheat3", lwd = 2)

abline(h = 0.5, lwd = 2, lty = 3)
axis(side=1, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1, at = 1:10)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1, at = 1:10)
axis(side=2, lwd.ticks = 2, labels = T, cex.axis = 1.2, las = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1, at = 1:10)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1, at = 1:10)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)

mtext(side = 1, text = labs, line = 1, at = seq(1:10), padj = 0.5, cex = 0.8)
mtext(side = 1, text = "Lake", line = 3, cex = 1.5)
mtext(side = 2, "Proportion of Community", line = 3.5, cex = 1.5)

box(lwd = 2)

# Add Legend
#par(mar = c(0, 0, 0, 0) )
#plot.new()

legend("topright", legend = c("Generalists", "Specialists"),
       pch = c(22, 24), pt.lwd = 2,
       pt.bg = "gray80",
       bty = "n", pt.cex = 1.25, cex = 1, ncol = 2, y.intersp = 1.5)



generalism <- matrix(NA, 10, 10)
colnames(generalism) <- c(1:10)
rownames(generalism) <- rownames(abundancesR)
for (j in c(1:9)){
  for (i in 1:dim(generalism)[1]){
    generalism.temp <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) <= j]
    generalism.temp.2 <- abundancesR[i, colnames(abundancesR) %in% generalism.temp]
    generalism[i,j] <- round(sum(generalism.temp.2), 3)
  }
}
for (i in 1:dim(generalism)[1]){
  generalism.temp <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) <= 30]
  generalism.temp.2 <- abundancesR[i, colnames(abundancesR) %in% generalism.temp]
  generalism[i,10] <- round(sum(generalism.temp.2), 3)
}

plot(generalism[1,], type = 'n', las = 1, axes = F,
     xlim = c(0.5,10.5), ylim = c(0,0.9),
     ylab = "",
     xlab = "")
for (i in 1:10){
  points(generalism[i, ], pch = 22, bg = "gray", lwd = 2, cex = 1.5)
}

abline(v = 2.5, lty = 2, lwd = 2)
abline(v = 6.5, lty = 3, lwd = 2)

axis(side=1, lwd.ticks = 2, tck=-0.04, labels = c("2", "4", "6", "8", "10+"), 
     at = c(seq(2,10,2)), cex.axis = 1, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 1, las = 1)

axis(side=1, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)

mtext(side = 1, "Number of Resources", cex = 1.5, line = 3)
mtext(side = 2, "Cumulative Proportion", cex = 1.5, line = 3.5)

box(lwd = 2)



dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Interaction Heatmap"}
img <- readPNG("../figures/Figure4.png")
grid.raster(img)
```

# Generalist:Specialists Ratio Plot: Sensitivity
```{r, results='hide'}
png(filename="../figures/Figure4B.png",
    width = 1200, height =800, res = 96*2)
par(opar)


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Generalists"}
img <- readPNG("../figures/Figure4B.png")
grid.raster(img)
```

# Who are the Generalists and Specialists
```{r}
length(specialists)
length(generalists)

generalists
OTU.tax[,1] <- gsub("Otu000", "OTU",OTU.tax[,1])
Gen.Tax <- OTU.tax[which(OTU.tax[,1] %in% generalists),]
Spe.Tax <- OTU.tax[which(OTU.tax[,1] %in% specialists),]

Gen.Tax.Class <- Gen.Tax$Class
Spe.Tax.Class <- Spe.Tax$Class
Gen.Tax.Gen <- Gen.Tax$Genus
Spe.Tax.Gen <- Spe.Tax$Genus

unique(Gen.Tax.Gen)
unique(Spe.Tax.Gen)

table(Gen.Tax.Gen)
table(Spe.Tax.Gen)

setdiff(unique(Gen.Tax.Gen), unique(Spe.Tax.Gen))
setdiff(unique(Spe.Tax.Gen), unique(Gen.Tax.Gen))
intersect(unique(Gen.Tax.Gen), unique(Spe.Tax.Gen))

```


# Consumer-Resource Feedbacks
## Graph Analysis Plot
```{r, results='hide'}
# Reorganize Data
feedbacks <- ConRes.matrix
str(feedbacks)
bacs <- dim(feedbacks)[1]
ress <- dim(feedbacks)[2]
bac <- rep(rownames(feedbacks), ress)
res <- rep(colnames(feedbacks), each = bacs)
int <- as.numeric(feedbacks[, 1])
for (i in 2:ress){
  int = append(int, as.numeric(feedbacks[, i]))
}
bac2 <- bac 
bac2 <- gsub("Otu000", "O", bac2)
graph.list.full <- data.frame(bac2, res, int)

png(filename="../figures/Figure5.png",
    width = 1800, height = 1800, res = 96*2, bg = "white")
par(opar)

# Plot Settings
layout(matrix(1:4, ncol = 2, byrow = T))
par(mar = c(1, 1, 2, 1), oma = c(1, 1, 2, 1))

# Positive Network
graph.list <- graph.list.full[graph.list.full$int > 0.86, ]
hmwf.network <- graph.data.frame(graph.list, directed=F)
hmwf.network <- simplify(hmwf.network)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 
E(hmwf.network)$color <- "red"

plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Production Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

# Negative Network
graph.list <- graph.list.full[graph.list.full$int < -0.86, ]
hmwf.network <- graph.data.frame(graph.list, directed=F)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 
E(hmwf.network)$color <- "blue"
plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Consumption Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

# Feedback Network
graph.list <- graph.list.full[abs(graph.list.full$int) > 0.87, ]

graph.list <- graph.list.full[union(which(graph.list.full$bac2 %in% 
                                      c("OTU006", "OTU020", 
                                        "OTU001", "OTU166",
                                        "OTU008")),
                                    which(graph.list.full$res %in%
                                      c("C551", "C3", "C86", "C652",
                                        "C187"))), ] 

graph.list <- graph.list[abs(graph.list$int) > 0.8 , ]

hmwf.network <- graph.data.frame(graph.list, directed=F)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])


# Plot
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 

E(hmwf.network)$color <- NA
E(hmwf.network)$color[which(graph.list$int < 0)] <- "blue"
E(hmwf.network)$color[which(graph.list$int > 0)] <- "red" 

plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Feedback Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

plot.new()

legend(0.1, 0.75, c("Bacteria", "DOM", "Neg. Interaction", "Pos. Interaction"), 
       pch = c(21, 21, 0, 0), lty = c(0, 0, 1, 1), lwd = c(0, 0, 3, 3),
       pt.bg = c("cornflowerblue", "wheat3", "white", "white"), 
       col = c("black", "black", "blue", "red"), pt.lwd = 1, pt.cex = c(3, 3, 0.1, 0.1),
       bty = "n", y.intersp = 2, xjust = 0, adj = c(0, 0.5))


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Networks"}
img <- readPNG("../figures/Figure5.png")
grid.raster(img)
```


# Supplemental
## Supplemental Figure 1: System Map
```{r fig.width=7, fig.height=3.5,echo=FALSE,fig.cap="Study System Map"}
img <- readPNG("../figures/SuppFigure1.png")
grid.raster(img)
```

## Supplemental Figure 2: Organic Matter Ordination Figure
```{r, results='hide'}
design2 <- design[design$Molecule == "DNA" & design$Year == "2012", ]
# Custom palette
palette(rainbow_hcl(10, c = 80, l = 60))
lake.col <- rep(NA, length(unique(design2$Lake)))
names(lake.col) <- unique(design2$Lake)
lake.col <- as.numeric(factor(design2$Lake))

png(filename="../figures/SuppFigure2.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

# Define Plot Parameters
layout(matrix(1))
par(mar = c(5, 5, 1, 1) + 0.5)

plot(pcoa.res$points[ ,1], pcoa.res$points[ ,2],
     ylim = c(-0.25, 0.3), xlim = c(-0.25, 0.3),
     xlab = paste("PCoA 1 (", explainvar1.res, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2.res, "%)", sep = ""),
     #xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 17, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1,
     axes = FALSE)

  # Add Axes
  axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  abline(h = 0, v = 0, lty = 3)
  box(lwd = 2)

# Add DOM Scores
arrows(0, 0, dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2, col = "red", length = 0.1)
text(dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2, rownames(dom.scores), col = "red", cex = 0.5)

# Add Points & Labels
points(pcoa.res$points[ ,1], pcoa.res$points[ ,2], pch = 15,
       cex = 4, bg = "gray", col = lake.col)
text(pcoa.res$points[ ,1], pcoa.res$points[ ,2], labels = row.names(pcoa.res$points))


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="PCoA Plot Resources"}
img <- readPNG("../figures/SuppFigure2.png")
grid.raster(img)
```
