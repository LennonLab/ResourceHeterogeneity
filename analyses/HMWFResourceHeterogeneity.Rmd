---
title: "Resource Heterogeneity Structures Microbial Communities"
author: "Mario E. Muscarella"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
   - \usepackage{graphics}
   - \usepackage{booktabs}
output: 
  pdf_document:
    fig_caption: true
---

# Introduction
What is this project about?
What are they hypotheses?

## Initial Setup
```{r, results='hide', message=FALSE, warning=FALSE}
rm(list=ls())
getwd()
setwd("~/GitHub/ResourceHeterogeneity/analyses")

# Import Tools and Standard Functions
source("../bin/MothurTools.R")
source("../bin/CommonFunctions.R")

# Save Standard Plot Settings
opar <- par(no.readonly = TRUE)  # Saves plot defaults

# Load Required Packages
require("png"); require("grid");require("vegan"); require("igraph")
library("BiodiversityR", quietly = T)
#require("xtable");require("png");require("grid");require("vegan")
#require("picante");require("phyloseq");require("car"); require("ade4")
#require("colorspace");require("bioDist");require("gplots")
#require("igraph");library("BiodiversityR")
```

# Load Data & Minor Processing
## Lake Nutrient Concentrations
```{r}
nuts <- read.csv(file = "../data/HMWF_Nutrients.txt", header = T)
```

## Load DOM Profiles
```{r}
# Define Inputs
# Resource = raw site-by-resource matrix
resource.pos <- "../data/SpecAbundAvePos.csv"
resource.neg <- "../data/SpecAbundAveNeg.csv"
design.in <- "../data/design.txt"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)

# Import Resources
res.in <- read.csv(resource.neg, header=T, row.names=1)
rownames(res.in) <- c("Ann", "blank", "CanyonChemo", "Canyon", "CanyonHypo",
                      "CanyonI", "CanyonII", "CanyonIII", "CanyonIV", "Howe",
                      "Ives", "Jordan", "Lily", "Mountain", "Pony", "Rush",
                      "SecondPine", "UpperPine")

blank <- unlist(res.in["blank", ])
res.hmwf <- res.in[-c(which(rownames(res.in) %in% c("blank", "CanyonChemo", 
                          "CanyonHypo", "CanyonI", "CanyonII",
                          "CanyonIII", "CanyonIV", "Jordan"))), ]

# Remove Blank Peaks
for (i in 1:dim(res.hmwf)[1]){
  res.hmwf[i, ] <- res.hmwf[i, ] - blank * 1.1
}

# Remove Peaks Under Height of 50
res.hmwf[res.hmwf < 50] <- 0

# Remove Zero Sum Columns
res.hmwf <- res.hmwf[,colSums(res.hmwf) > 0]

# Data Transformations
# Reorder Sites
res <- res.hmwf[order(rownames(res.hmwf)), ]

# Sequencing Coverage
coverage <- rowSums(res)
resources <- dim(res)[2]

# Make Relative Abundence Matrices
resREL <- res
for(i in 1:dim(res)[1]){
  resREL[i,] <- res[i,]/sum(res[i,])
}

# Log Transform Relative Resource Abundance
resREL.log <- decostand(resREL, method="log")
```

## Load Bacterial Community Data
```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU
design.in <- "../data/design.txt"
shared <- "../data/HMWF.bac.final.shared"
taxon  <- "../data/HMWF.bac.final.0.03.taxonomy"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)

# Import Shared Files
OTUs.in <- read.otu(shared = shared, cutoff = "0.03")    # 97% Similarity

# Import Taxonomy
OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Data Transformations
# Reorder Site
OTUs.hmwf <- OTUs.in[rownames(design), ]

# Remove OTUs with less than two occurences across all sites
# OTUs <- OTUs.hmwf[, which(colSums(OTUs.hmwf) >= 2)]
OTUs <- OTUs.hmwf[, colSums((OTUs.hmwf > 0) * 1)  >= 2 | colSums(OTUs.hmwf) >= 10]

# Sequencing Coverage
coverage <- rowSums(OTUs)
bacteria <- dim(OTUs)[2]

# Good's Coverage
goods.c <- goods(OTUs)

# Make Presence Absence Matrix
OTUsPA <- (OTUs > 0) * 1

# Make Relative Abundence Matrices
OTUsREL <- OTUs
for(i in 1:dim(OTUs)[1]){
  OTUsREL[i,] <- OTUs[i,]/sum(OTUs[i,])
}

# Log Transform Relative Abundances
OTUsREL.log <- decostand(OTUs, method="log")
```

# Statistical Description of Resources
```{r}
range(nuts$DOC);range(nuts$TN);range(nuts$TP)

CV(nuts$DOC)
CV(nuts$TN)
CV(nuts$TP)

cor.test(nuts$DOC, nuts$TN)
cor.test(nuts$TN, nuts$TP)
cor.test(nuts$DOC, nuts$TP)


# Principal Components Axis
nuts.pca <- princomp(nuts[, 4:5])
summary(nuts.pca)
nuts.axis <- nuts.pca$scores[,1]

PCA.res <- princomp(cbind(scale(nuts$DOC), scale(nuts$TN), scale(nuts$TP)))
summary(PCA.res)
     
PCA.res1 <- scale(PCA.res$scores[,1])
```

# Statistical Description of DOM Structural Diversity 
```{r}
# Observed Richness
S.res <- rowSums((res > 0) * 1)

# Simpson's Evenness
res.simpsE <- round(apply(res, 1, SimpE), 3)

# Shannon's Diversity
res.shan <- round(vegan::diversity(res, index = "shannon"), 2)

# Combine Alpha Diversity
res.div <- as.data.frame(cbind(S.res, res.simpsE, res.shan))

# Summary Stats
range(res.div$S.res);range(res.div$res.shan);range(res.div$res.simpsE)
CV(res.div$S.res);CV(res.div$res.shan);CV(res.div$res.simpsE)
```

# DOM Compositional Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.res <- vegdist(resREL, method = "bray")
# hmwf.bray.res <- vegdist(resREL.log, method = "bray")

dis.mean <- mean(hmwf.bray.res)

# Principal Coordinates Analysis
pcoa.res <- cmdscale(hmwf.bray.res, eig = TRUE, k = 3) 
explainvar1.res <- round(pcoa.res$eig[1] / sum(pcoa.res$eig), 3) * 100
explainvar2.res <- round(pcoa.res$eig[2] / sum(pcoa.res$eig), 3) * 100
explainvar3.res <- round(pcoa.res$eig[3] / sum(pcoa.res$eig), 3) * 100
sum.eig.res <- sum(explainvar1.res, explainvar2.res, explainvar3.res)

# DOM Scores
dom.scores <- add.spec.scores(pcoa.res,res,method="cor.scores",multi=1,Rscale=F,scaling="1")
dom.scores <- as.matrix(dom.scores$cproj)[,1:2]
dom.scores <- dom.scores[abs(dom.scores[,1]) > 0.7 | abs(dom.scores[,2]) > 0.7, ]

write.table(round(dom.scores, 3), file = "../data/HMWF_DOM.txt", sep = "\t", quote = F,
            col.names = NA)
```


# Statistical Description of Bacterial Structural Diversity
```{r}
# Observed Richness
S.obs <- rowSums((OTUs > 0) * 1)

# Simpson's Evenness
simpsE <- round(apply(OTUs, 1, SimpE), 3)

# Shannon's Diversity
shan <- vegan::diversity(OTUs, index = "shannon")

# Rarefied Richness
S.rar <- round(rarefy(OTUs, min(rowSums(OTUs))), 0)

alpha.div <- cbind(design, S.obs, simpsE, shan, S.rar)
alpha.div <- alpha.div[order(alpha.div$Lake, alpha.div$Year, alpha.div$Molecule), ]

# Summary Stats
range(alpha.div$S.rar);range(alpha.div$simpsE)
CV(alpha.div$S.rar);CV(alpha.div$simpsE)
CV(alpha.div$S.rar[alpha.div$Lake != "Pony" & alpha.div$Lake != "Lily"])
range(alpha.div$S.rar[alpha.div$Lake != "Pony" & alpha.div$Lake != "Lily"])
```

## Bacterial Compositional Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.REL <- vegdist(OTUsREL, method = "bray")

dis.mean <- mean(hmwf.bray.REL)

adonis(hmwf.bray.REL ~ design$Molecule)

# Principal Coordinates Analysis 
pcoa.rel <- cmdscale(hmwf.bray.REL, eig = TRUE, k = 3) 
explainvar1.rel <- round(pcoa.rel$eig[1] / sum(pcoa.rel$eig), 3) * 100
explainvar2.rel <- round(pcoa.rel$eig[2] / sum(pcoa.rel$eig), 3) * 100
explainvar3.rel <- round(pcoa.rel$eig[3] / sum(pcoa.rel$eig), 3) * 100
sum.eig.rel <- sum(explainvar1.rel, explainvar2.rel, explainvar3.rel)

# OTU Scores
otu.scores <- add.spec.scores(pcoa.rel,OTUsREL,method="cor.scores",multi=1,Rscale=F,scaling="1")
otu.scores <- as.matrix(otu.scores$cproj)[,1:2]
otu.scores <- otu.scores[abs(otu.scores[,1]) > 0.65 | abs(otu.scores[,2]) > 0.65, ]
```

# Resource Heterogeneity and Community Diversity
## Structural Relationships
```{r}
# Organize Data
nuts$PCA <- as.numeric(PCA.res1 + 1)
dat1D <- data.frame(alpha.div[alpha.div$Molecule == "DNA", ], nuts[order(nuts$Site), ])
dat1R <- data.frame(alpha.div[alpha.div$Molecule == "RNA", ], nuts[order(nuts$Site), ])
dat2D <- data.frame(dat1D[dat1D$Year == "2012", ], res.div[order(rownames(res.div)), ])
dat2R <- data.frame(dat1R[dat1R$Year == "2012", ], res.div[order(rownames(res.div)), ])
dat2  <- data.frame(rbind(dat2D, dat2R))
dat2  <- dat2[order(dat2$Lake), ]

# Resource Concentration and Diversity (Total)
mod1 <- lm(S.rar ~ PCA, data = dat1D[dat1D$Lake != "Pony", ])
mod2 <- lm(simpsE ~ PCA, data = dat1D[dat1D$Lake != "Pony", ])
summary(mod1);summary(mod2)

# Resource Heterogeneity and Divesity (Total)
mod3 <- lm(S.rar ~ S.res, data = dat2D[dat2D$Lake != "Pony", ])
mod4 <- lm(simpsE ~ S.res, data = dat2D[dat2D$Lake != "Pony", ])
summary(mod3);summary(mod4)

# Same Tests with Active Community
mod5 <- lm(S.rar ~ PCA, data = dat1R[dat1R$Lake != "Pony", ])
mod6 <- lm(simpsE ~ PCA, data = dat1R[dat1R$Lake != "Pony", ])
mod7 <- lm(S.rar ~ S.res, data = dat2R[dat2R$Lake != "Pony", ])
mod8 <- lm(simpsE ~ S.res, data = dat2R[dat2R$Lake != "Pony", ])
summary(mod8)

# Stats
mod4.p <- round(summary(mod4)$coefficients[2,4], 3)

# Prediction Frames
pred.frame1 <- data.frame(PCA = seq(0, 2.1, 0.1))
pred.frame2 <- data.frame(S.res = seq(542,572,2))

# Correlation Test
cor.test(~ S.res + PCA, data = dat2D[dat2D$Lake != "Pony", ])
```

## Structural Relationship Plots
```{r, results = "hide"}
# Confidence Hulls
add.hull <- function(model = "", pred.frame = ""){
  CI.U <- predict(model, interval = "c", newdata=pred.frame)[, "upr"]
  CI.L <- predict(model, interval = "c", newdata=pred.frame)[, "lwr"]
  pred.frame2 <- unlist(pred.frame)
  X.Vec <- c(pred.frame2, tail(pred.frame2, 1), rev(pred.frame2),
               head(pred.frame2, 1))
  Y.Vec <- c(CI.U, tail(CI.L, 1), rev(CI.L), head(CI.U,1))
  polygon(X.Vec, Y.Vec, col = "gray90", border = NA)
}

png(filename="../figures/Figure1.png",
    width = 1600, height = 1600, res = 96*2, bg = "white")
par(opar)

layout(matrix(1:4, nrow = 2, byrow = F))
par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(5, 5.5, 0, 0) + 0.1)

# Resource Concentration vs Species Richness
plot(dat1D$S.rar ~ dat1D$PCA, 
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 2.1), ylim = c(400, 1200), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod1, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod1, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat1D$S.rar ~ dat1D$PCA,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("bottomright", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1, inset = 0.01)
# mtext("Nutrients", side = 1, line = 3, cex = 1.5)
mtext("Species Richness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(0, 2))
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)

# Resource Concentration vs Species Evenness
plot(dat1D$simpsE ~ dat1D$PCA,
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 2.1), ylim = c(0, 0.06), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod2, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod2, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat1D$simpsE ~ dat1D$PCA,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1, inset = 0.01)
mtext("Resource Concentration", side = 1, line = 3.5, cex = 1.5)
mtext("Species Evenness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = c("low", "high"), at = c(0, 2))
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

# Resource Richness vs Species Richness
plot(dat2D$S.rar ~ dat2D$S.res,
     xlab = "", ylab = "", type = "n", axes = F,
     xlim = c(540, 572), ylim = c(400, 1200), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod3, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod3, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2D$S.rar ~ dat2D$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(N.S.)), 
       bty = "n", cex = 1, inset = 0.01)
# mtext("DOM Richness", side = 1, line = 3, cex = 1.5)
# mtext("Species Richness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(seq(540, 570, 10)))
axis(2, lwd = 2, labels = F, las = 1)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(540, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(540, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(540, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)

# Resource Richness vs Species Eveness
plot(dat2D$simpsE ~ dat2D$S.res,
     xlab = "", ylab = "", type = "n", axes = F,
     xlim = c(540, 572), ylim = c(0, 0.06), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod4, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod4, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat2D$simpsE ~ dat2D$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("bottomright", legend = bquote(italic(P) == .(mod4.p)), 
       bty = "n", cex = 1, inset = 0.01)
mtext("DOM Richness", side = 1, line = 3.5, cex = 1.5)
# mtext("Species Evenness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, las = 1, at = c(seq(540, 570, 10)))
axis(2, lwd = 2, labels = F, las = 1, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(540, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(540, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(540, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
par(opar)
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/Figure1.png")
grid.raster(img)
```

## Compositional Relationships (dbRDA)
```{r, results = 'hide', warning = FALSE}
# Define Environmental Gradients
## Resource Concentration
## dat1D; dat1R; dat2D; dat2R

## DOM Composition
## pcoa.res$points[, 1]; pcoa.res$points[, 2]; pcoa.res$points[, 3]

## Community Composition
# Define DNA and RNA Community
OTUsREL.D <- OTUsREL[design$Molecule == "DNA" , ]
OTUsREL.R <- OTUsREL[design$Molecule == "RNA" , ]
OTUsREL.D2012 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" , ]
OTUsREL.R2012 <- OTUsREL[design$Molecule == "RNA" & design$Year == "2012" , ]

# Calculate Bray-Curtis Distances for Bacteria
Bray.REL.D <- vegdist(decostand(OTUsREL.D, "log"), "bray")
Bray.REL.R <- vegdist(decostand(OTUsREL.R, "log"), "bray")
Bray.REL.D2012 <- vegdist(decostand(OTUsREL.D2012, "log"), "bray")
Bray.REL.R2012 <- vegdist(decostand(OTUsREL.R2012, "log"), "bray")

# Resource Concentration dbRDA 
dbRDA.D <- capscale(Bray.REL.D ~ dat1D$PCA, comm = OTUsREL.D, add = T)
dbRDA.R <- capscale(Bray.REL.R ~ dat1R$PCA, comm = OTUsREL.R, add = T)
bdRDA.D2012 <- capscale(Bray.REL.D2012 ~ dat2D$PCA, comm = OTUsREL.D2012, add = T)
dbRDA.R2012 <- capscale(Bray.REL.R2012 ~ dat2R$PCA, comm = OTUsREL.R2012, add = T)

anova(bdRDA.D2012, permutations = how(nperm=9999))
RsquareAdj(bdRDA.D2012)
anova(dbRDA.R2012, permutations = how(nperm=9999))
RsquareAdj(dbRDA.R2012)

# With Pony and Lily Removed (DNA)
dat2D.2 <- dat2D[dat2D$Lake != "Pony" & dat2D$Lake != "Lily", ]
OTUsREL.D.2 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" & 
                         design$Lake != "Pony" & design$Lake != "Lily", ]
Bray.REL.D.2 <- vegdist(OTUsREL.D.2, "bray")
dbRDA.D.2 <- capscale(Bray.REL.D.2 ~ dat2D.2$PCA, comm = OTUsREL.D.2, add = T)

anova(dbRDA.D.2, permutations = how(nperm=9999))
RsquareAdj(dbRDA.D.2)

# DOM Diversity dbRDA
Bray.RES <- vegdist(decostand(resREL, "log"), "bray")
pcoa.RES <- cmdscale(Bray.RES, k = 3, eig = T)
dbRDA.D.DOM <- capscale(Bray.REL.D2012 ~ pcoa.RES$points, 
                                comm = OTUsREL.D2012, add = T)
dbRDA.R.DOM <- capscale(Bray.REL.R2012 ~ pcoa.RES$points,
                                comm = OTUsREL.R2012, add = T)

anova(dbRDA.D.DOM, permutations = how(nperm=9999))
RsquareAdj(dbRDA.D.DOM)
anova(dbRDA.R.DOM, permutations = how(nperm=9999))
RsquareAdj(dbRDA.R.DOM)

# With Pony and Lily Removed (DNA)
## Subset OTUs
OTUsREL.D.2 <- OTUsREL[design$Molecule == "DNA" & design$Year == "2012" & 
                       design$Lake != "Pony" & design$Lake != "Lily", ]
rownames(OTUsREL.D.2) <- gsub("2012_DNA", "", rownames(OTUsREL.D.2))
Bray.REL.D2012.2 <- vegdist(decostand(OTUsREL.D.2, "log"), method = "bray")

## Subset Resources
resREL2 <- resREL[rownames(resREL) != "Pony" & rownames(resREL) != "Lily", ]
Bray.RES2 <- vegdist(resREL2, method = "bray")
pcoa.RES2 <- cmdscale(Bray.RES2, eig = TRUE, k = 2)

## dbRDA Analysis
dbRDA.D.DOM.2 <- capscale(Bray.REL.D2012.2 ~ pcoa.RES2$points, add = T)
anova(dbRDA.D.DOM.2, permutations = how(nperm=9999), model = "direct")
RsquareAdj(dbRDA.D.DOM.2)

# Resource Concentration/Composition Correlations
cor.test(dat2D$PCA, pcoa.res$points[,1])
cor.test(dat2D$PCA, pcoa.res$points[,2])
cor.test(dat2D$PCA, pcoa.res$points[,3])
```

# Bacterial PCoA Plot with Env Vectors
```{r, results='hide'}
# PCoA of Total Community
bray.BAC <- vegdist(decostand(OTUsREL, "log"), "bray")
pcoa.BAC <- cmdscale(Bray.REL.D2012, k = 2, eig = T)
explainvar1 <- round(pcoa.BAC$eig[1] / sum(pcoa.BAC$eig), 3) * 100
explainvar2 <- round(pcoa.BAC$eig[2] / sum(pcoa.BAC$eig), 3) * 100

# PCoA of Resoruces
bray.RES <- vegdist(decostand(resREL, "log"), "bray")
pcoa.RES <- cmdscale(bray.RES, k = 3, eig = T)

# Resource Concentrations
cons.RES <- dat2D$PCA

# Initial Plot as PNG
png(filename="../figures/Figure2.png",
    width = 1300, height = 900, res = 96*2, bg = "white")

# Define Plot Parameters
par(opar)
par(mar = c(4, 5, 1, 1) + 0.5)

# Initiate Plot 1
plot(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], 
     ylim = c(-0.4, 0.4), xlim = c(-0.4, 0.6), 
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     #xlab = "", ylab = "", xaxt = "n", yaxt = "n",
     pch = 22, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1, 
     axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
  
# Add Points & Labels
points(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], pch = 22, 
       cex = 2, bg = "gray", lwd = 2)

# Resource Concentration Vector
res.con <- envfit(pcoa.BAC, cons.RES)
con.arrows <- res.con[[1]]$arrows * 0.5
arrows(0, 0, con.arrows[, 1], con.arrows[, 2], col = "red", length = 0.1, lwd = 2)
text(con.arrows[, 1] * 1.2, con.arrows[, 2] * 1.2, "Conc.", col = "red", cex = 1)

# DOM Composition Vectors
res.com <- envfit(pcoa.BAC, pcoa.RES$points[,1:2])
com.arrows <- res.com[[1]]$arrows * 0.3
arrows(0, 0, com.arrows[1, 1], com.arrows[1, 2], col = "red", length = 0.1, lwd = 2)
arrows(0, 0, com.arrows[2, 1], com.arrows[2, 2], col = "red", length = 0.1, lwd = 2)
text(com.arrows[1, 1] * 1.15, com.arrows[1, 2] * 1.15, "DOM 1", col = "red", cex = 1)
text(com.arrows[2, 1] * 1, com.arrows[2, 2] * 1.15, "DOM 2", col = "red", 
     cex = 1, pos = 1)

text(0.45, -0.1, "Pony", col = "black", cex = 0.8)
text(0.55, 0.15, "Lily", col = "black", cex = 0.8)

par(opar)
dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/Figure2.png")
grid.raster(img)
```

# Consumer Resource Specialization


