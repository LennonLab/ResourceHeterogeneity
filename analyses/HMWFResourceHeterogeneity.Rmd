---
title: "Resource Heterogeneity Structures Microbial Communities"
author: "Mario E. Muscarella"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
   - \usepackage{graphics}
   - \usepackage{booktabs}
output: 
  pdf_document:
    fig_caption: true
---

# Introduction
Community diversity is strongly affected by the bottom-up effects of resource availability. However, because resource pools often exist as heterogeneous mixtures of individual resources, resource heterogeneity may also affect the diversity of local communities. To test this hypothesis, we surveyed bacterial communities in lakes that spanned a resource concentration gradient. In addition, we characterized resource heterogeneity in these lakes using high-resolution mass spectrometry of the dissolved organic matter (DOM) pool. Using these data, we will test for relationships between the available resources and the aquatic heterotrophic bacteria community, and we will use co-occurrence analysis to test for bacteria-resource interactions. 

## Initial Setup
```{r, results='hide', message=FALSE, warning=FALSE}
rm(list=ls())
setwd("~/GitHub/ResourceHeterogeneity/analyses")

# Import Tools and Standard Functions
source("../bin/MothurTools.R")
source("../bin/CommonFunctions.R")

# Save Standard Plot Settings
opar <- par(no.readonly = TRUE)  # Saves plot defaults

# Load Required Packages
require("png"); require("grid");require("vegan"); require("igraph")
require("picante");require("bioDist");require("gplots")
#require("xtable");require("phyloseq");require("car"); require("ade4");require("bioDist")
require("colorspace"); library("car")
source("../bin/box.cox.chord.R")
```

# Load Data & Minor Processing
## Lake Nutrient Concentrations and Physical Properties
```{r}
nuts <- read.csv(file = "../data/HMWF_Nutrients.txt", header = T)
chl <- read.delim(file = "../data/ChlorophyllA.txt", header = T)
chl <- chl[order(chl$Year, chl$Lake), ]
phys <- read.csv(file = "../data/lake_data2.txt", header = T)
all.equal(nuts$Site, chl$Lake); all.equal(nuts$Year, chl$Year);
all.equal(nuts$Site[nuts$Year == 2012], phys$Lake)
```

## Load DOM Profiles
```{r}
# Define Inputs
# Resource = raw site-by-resource matrix
resource.neg <- "../data/SpecAbundAveNeg.csv"
design.in <- "../data/design.txt"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)

# Import Resources
res.neg.in <- read.csv(resource.neg, header=T, row.names=1)
rownames(res.neg.in) <- c("Ann", "blank", "CanyonChemo", "Canyon", "CanyonHypo",
                      "CanyonI", "CanyonII", "CanyonIII", "CanyonIV", "Howe",
                      "Ives", "Jordan", "Lily", "Mountain", "Pony", "Rush",
                      "SecondPine", "UpperPine")

# Remove Blank and Extra Samples
blank.neg <- unlist(res.neg.in["blank", ])
res.hmwf.neg <- res.neg.in[-c(which(rownames(res.neg.in) %in% 
                            c("blank", "CanyonChemo", 
                              "CanyonHypo", "CanyonI", "CanyonII",
                              "CanyonIII", "CanyonIV", "Jordan"))), ]

# Remove Blank Peaks
for (i in 1:dim(res.hmwf.neg)[1]){
  res.hmwf.neg[i, ] <- res.hmwf.neg[i, ] - blank.neg * 1.1
}

# Remove Peaks Under Height of 50
res.hmwf.neg[res.hmwf.neg < 50] <- 0

# Remove Zero Sum Columns
res.hmwf.neg <- res.hmwf.neg[,colSums(res.hmwf.neg) > 0]

# Data Transformations
# Reorder Sites
res.neg <- res.hmwf.neg[order(rownames(res.hmwf.neg)), ]

# Sequencing Coverage
coverage <- data.frame(Neg = rowSums(res.neg))
resources <- data.frame(Neg = dim(res.neg)[2])

# Make Relative Abundence Matrices
resREL.neg <- res.neg
for(i in 1:dim(res.neg)[1]){
  resREL.neg[i,] <- res.neg[i,]/sum(res.neg[i,])
}

# Log Transform Relative Resource Abundance
resREL.neg.log <- suppressWarnings(decostand(resREL.neg, method="log"))

# Box-Cox Chord Transformation
DOM.BCD <- box.cox.chord(res.neg)  #Log Chord Transformation
```

## Load DOM Metadata
```{r}
# Read in the data
x <- scan("../data/data_20151106/neg/spectra/MarioAquaticNeg.mspLib", 
          what="", sep="\n")
ind.n <- grep("Name:", x)
neg.meta <- data.frame(matrix(NA, nrow = length(ind.n), ncol = 3))
colnames(neg.meta) <- c("Name", "Rt", "mz.max")

for (i in 1:length(ind.n)){
  neg.meta[i, 1] <- unlist(strsplit(x[ind.n[i]], ": "))[2]
  temp.comment <- unlist(strsplit(x[ind.n[i] + 12], " "))
  neg.meta[i, 2] <- as.numeric(gsub("Rt=", "", 
                                    temp.comment[grep("Rt=", temp.comment)]))
  temp.peaks <- unlist(strsplit(x[ind.n[i] + 14], " "))
  temp.mz <- as.numeric(temp.peaks[seq(1, length(temp.peaks), by = 2)])
  temp.intensity <- as.numeric(temp.peaks[seq(2, length(temp.peaks), by = 2)])
  neg.meta[i, 3] <- max(temp.mz)
}

neg.meta <- neg.meta[match(colnames(resREL.neg), neg.meta$Name), ]
```

## Load Bacterial Community Data
```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU
design.in <- "../data/design.txt"
shared <- "../data/HMWF.final.opti.shared"
taxon  <- "../data/HMWF.final.opti.taxonomy"

# Import Design
design <- read.delim(design.in, header=T, row.names=1)
design <- design[design$Molecule == "RNA" & design$Year == "2012", ]

# Import Shared Files
OTUs.in <- read.otu(shared = shared, cutoff = "0.03")  

# Import Taxonomy
OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Remove Cyanobacteria
OTUs.in.2 <- OTUs.in[, -c(which(OTU.tax$Phylum == "Cyanobacteria/Chloroplast"))]
dim(OTUs.in.2)

OTU.tax.2 <- OTU.tax[which(OTU.tax$OTU %in% colnames(OTUs.in.2)), ]
table(OTU.tax.2$Class)
table(OTU.tax.2$Phylum)

# Data Transformations
# Reorder Site
OTUs.hmwf <- OTUs.in.2[rownames(design), ]

# Remove OTUs with less than two occurences across all sites
# OTUs <- OTUs.hmwf[, which(colSums(OTUs.hmwf) >= 2)]
OTUs <- OTUs.hmwf[, colSums((OTUs.hmwf > 0) * 1)  >= 2 | colSums(OTUs.hmwf) >= 3]
S.obs <- rowSums((OTUs > 0) * 1)

# Sequencing Coverage
coverage <- rowSums(OTUs)

bacteria <- dim(OTUs)[2]
dim(OTUs)

# Good's Coverage
goods.c <- goods(OTUs)

# Make Presence Absence Matrix
OTUsPA <- (OTUs > 0) * 1

# Make Relative Abundence Matrices
OTUsREL <- OTUs
for(i in 1:dim(OTUs)[1]){
  OTUsREL[i,] <- OTUs[i,]/sum(OTUs[i,])
}

# Log Transform Relative Abundances
OTUsREL.log <- suppressWarnings(decostand(OTUs, method="log"))

# Box-Cox Chord Transformation
OTUs.BCD <- box.cox.chord(OTUs)  #Log Chord Transformation
```

# Resources
## Figure S2: DOC, TN
```{r, results = "hide"}
# DOC TN correlation
cor.test(nuts$DOC, nuts$TN)
cor.test(nuts$DOC, nuts$TP)

png(filename="../figures/FigureS2.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)
par(mar = c(5, 5, 1, 1) + 0.1)
plot(x = log10(nuts$DOC), y = log10(nuts$TN), 
     ylim = c(-0.6, 0.3), xlim = c(0.5, 1.6),
     xlab = "", ylab = "",
     pch = 21, bg = "gray", cex = 1.5, lwd=2, axes=F)

mod1 <- lm(log10(nuts$TN) ~ log10(nuts$DOC))
cor(log10(nuts$DOC), log10(nuts$TN))
text(log10(4.6), log10(1.8), expression(paste(rho, " = 0.94", sep = "")), 
     cex = 1.25)
clip(log10(4), log10(35.4), log10(0.24), log10(2))
abline(mod1, lwd = 2, col = "gray20", lty = 2)

axis(2, at = c(-0.6, -0.3, 0, 0.3), labels = c(0.25, 0.5, 1, 2), 
     las = 1, lwd = 1.5, cex.axis = 1.25)
axis(1, at = c(0.7, 1, 1.47), labels = c(5, 10, 30), las = 1, lwd = 1.5, cex.axis = 1.25)
axis(4, at = c(-0.6, -0.3, 0, 0.3), tck = -0.02, labels = F, lwd = 1.5)
axis(3, at = c(0.7, 1, 1.47), tck = -0.02, labels = F, las = 1, lwd = 1.5)
axis(2, at = c(-0.6, -0.3, 0, 0.3), tck = 0.01, labels = F, lwd = 1.5)
axis(1, at = c(0.7, 1, 1.47), tck = 0.01, labels = F, las = 1, lwd = 1.5)
axis(4, at = c(-0.6, -0.3, 0, 0.3), tck = 0.01, labels = F, lwd = 1.5)
axis(3, at = c(0.7, 1, 1.47), tck = 0.01, labels = F, las = 1, lwd = 1.5)
mtext(expression(paste("TN (mg N L"^-1, ")")), side = 2, line = 3, cex = 1.5)
mtext(expression(paste("DOC (mg C L"^-1, ")")), side = 1, line = 3, cex = 1.5)
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/FigureS2.png")
grid.raster(img)
```

## DOM Alpha Diversity 
```{r}
# Observed Richness
S.res <- rowSums((res.neg > 0) * 1)

# Simpson's Evenness
res.simpsE <- round(apply(res.neg, 1, SimpE), 3)

# Shannon's Diversity
res.shan <- round(vegan::diversity(res.neg, index = "shannon"), 2)

# Combine Alpha Diversity
res.div <- data.frame("Lake" = row.names(res.neg), S.res, res.simpsE, res.shan)

# Summary Stats
range(res.div$S.res);range(res.div$res.shan);range(res.div$res.simpsE)
CV(res.div$S.res);CV(res.div$res.shan);CV(res.div$res.simpsE)
```

## DOM Beta Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.res <- vegdist(resREL.neg, method = "bray")
hmwf.bray.res.log <- vegdist(resREL.neg.log, method = "bray")

dis.mean <- mean(hmwf.bray.res)
dis.mean.l <- mean(hmwf.bray.res.log)

hmwf.bcd.res <- vegdist(DOM.BCD, method = "euclidean")
dis.mean.b <- mean(hmwf.bcd.res)

# Principal Coordinates Analysis
pcoa.res <- cmdscale(hmwf.bray.res, eig = TRUE, k = 3) 
explainvar1.res <- round(pcoa.res$eig[1] / sum(pcoa.res$eig), 3) * 100
explainvar2.res <- round(pcoa.res$eig[2] / sum(pcoa.res$eig), 3) * 100
explainvar3.res <- round(pcoa.res$eig[3] / sum(pcoa.res$eig), 3) * 100
sum.eig.res <- sum(explainvar1.res, explainvar2.res, explainvar3.res)

# DOM Scores
dom.scores <- t(cor(pcoa.res$points,resREL.neg, method = "spearman"))
dom.scores <- as.matrix(dom.scores)
# dom.scores <- dom.scores[abs(dom.scores[,1]) > 0.7 | 
#                          abs(dom.scores[,2]) > 0.7 , ]

dom.scores <- dom.scores[abs(dom.scores[,1]) > 0.7 |
                         abs(dom.scores[,2]) > 0.7 |
                         abs(dom.scores[,3]) > 0.7, ]

dim(dom.scores)

dom.scores <- as.data.frame(dom.scores)
dom.scores[, 4:5] <- NA
colnames(dom.scores) <- c("Axis_1", "Axis_2", "Axis_3", "Rt", "mz")

for (i in 1:dim(dom.scores)[1]){
  temp <- which(neg.meta$Name == rownames(dom.scores)[i])
  dom.scores[i, 4] <- as.numeric(neg.meta$Rt[temp[1]])
  dom.scores[i, 5] <- as.numeric(neg.meta$mz.max[temp[1]])
}

write.table(round(dom.scores, 3), file = "../data/HMWF_DOM_NEG.txt", 
            sep = "\t", quote = F, col.names = NA)
```

## Figure 1: Organic Matter Ordination and Env Vectors
```{r, results='hide'}
# Custom palette
palette(rainbow_hcl(10, c = 80, l = 60))
lake.col <- rep(NA, length(unique(design$Lake)))
names(lake.col) <- unique(design$Lake)
lake.col <- as.numeric(factor(design$Lake))

# Nutrients
all.equal(nuts$Site, chl$Lake); all.equal(nuts$Site[nuts$Year == 2012], phys$Lake)
lake.env <- cbind(nuts[nuts$Year == 2012, 3:5], 
                  Chl = chl[chl$Year == 2012, 3], phys[, 4:5])
row.names(lake.env) <- phys$Lake

norm.tests <- apply(lake.env, 2, shapiro.test)
# Normal: TP
# Not Normal: DOC, TN, Chl, area, pH

lake.env.t <- lake.env * NA
for(i in 1:dim(lake.env.t)[2]){
  D.power <- powerTransform(lake.env[, i])
  lake.env.t[, i] <- as.numeric(scale(bcPower(lake.env[, i], 
                                              coef(D.power, round =F))))
}

dom.size <- log(lake.env$DOC)

png(filename="../figures/Figure1.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

# Define Plot Parameters
layout(matrix(1))
par(mar = c(5, 5, 1, 1) + 0.5)

plot(pcoa.res$points[ ,1], pcoa.res$points[ ,2],
     ylim = c(-0.25, 0.3), xlim = c(-0.25, 0.3),
     xlab = paste("PCoA 1 (", explainvar1.res, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2.res, "%)", sep = ""),
     #xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 17, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1,
     axes = FALSE)

  # Add Axes
  axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  abline(h = 0, v = 0, lty = 3)
  box(lwd = 2)

# Add DOM Scores
# arrows(0, 0, dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2,
#        col = "red", length = 0.1, lwd = 0.5)
# text(dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2, rownames(dom.scores),
#      col = "red", cex = 0.5)
# Add DOM Scores with mz/Rt info
neg.meta2 <- neg.meta[match(rownames(dom.scores), neg.meta$Name), ]
  
# Add Environmental Vectors
res.env <- envfit(pcoa.res, lake.env)
res.arrows <- res.env[[1]]$arrows * 0.2
arrows(0, 0, res.arrows[, 1], res.arrows[, 2], 
       col = "gray10", length = 0.1, lwd = 2, lty = c(1, 1, 3, 1, 3, 1)) 
arrows(res.arrows[, 1] * 0.99, res.arrows[, 2] * 0.99, 
       res.arrows[, 1], res.arrows[, 2], 
       col = "gray10", length = 0.1, lwd = 2)
text(res.arrows[, 1] + 
       c(-0.03, 0.04, 0.03, 0.04, -0.03, -0.03), 
     res.arrows[, 2] + 
       c(0.03, 0.01, 0.02, -0.01, -0.03, -0.03), 
     row.names(res.arrows), col = "gray40", cex = 1, font = 3)

# Add Points & Labels
points(pcoa.res$points[ ,1], pcoa.res$points[ ,2], pch = 22, 
       cex = dom.size, bg = "gray", lwd = 2)
       
       #pch = 15, cex = 4, bg = "gray", col = lake.col)
text(pcoa.res$points[ ,1]  + c(0, 0, 0.04, 0, -0.04, 0, 0, 0, 0.04, 0),
     pcoa.res$points[ ,2] + c(-0.035, 0.035, -0.035, 0.035, 0.035, 
                              -0.035, 0.035, -0.035, -0.035, -0.04), 
     labels = row.names(pcoa.res$points))

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="PCoA Plot Resources"}
img <- readPNG("../figures/Figure1.png")
grid.raster(img)
```

# Alpha Diversity
## Bacterial Alpha Diversity
```{r}
# Observed Richness
S.obs <- rowSums((OTUs > 0) * 1)

# Simpson's Evenness
simpsE <- round(apply(OTUs, 1, SimpE), 3)

# Shannon's Diversity
shan <- vegan::diversity(OTUs, index = "shannon")

# Rarefied Richness
OTUs.rar <- rrarefy(OTUs, ceiling(min(rowSums(OTUs)) * 0.9))
S.rar <- round(rarefy(OTUs, ceiling(min(rowSums(OTUs)) * 0.9)), 0)

# Simpson's Evenness
simpsE.rar <- round(apply(OTUs.rar, 1, SimpE), 3)

# Shannon's Diversity
shan.rar <- vegan::diversity(OTUs.rar, index = "shannon")

alpha.div <- cbind(design, S.obs, simpsE, shan, S.rar, simpsE.rar, shan.rar)
alpha.div <- alpha.div[order(alpha.div$Lake, alpha.div$Year, alpha.div$Molecule), ]

# Summary Stats
range(alpha.div$S.rar);range(alpha.div$simpsE)
CV(alpha.div$S.rar);CV(alpha.div$simpsE)
```

## Resource Heterogeneity and Community Diversity Relationships
```{r}
# Organize Data
nuts2 <- nuts[nuts$Year == 2012, ]
nuts2 <- nuts2[order(nuts2$Site), ]

all.equal(nuts2$Site, alpha.div$Lake)
all.equal(nuts2$Site, res.div$Lake)
all.equal(nuts2$Site, phys$Lake)

dat <- data.frame(alpha.div[, c(1, 4:7)], res.div[, 2:4], 
                  nuts2[, 3:5], phys[, c(4,5,7,9)], 
                  row.names = alpha.div[, 1])

shapiro.test(dat$DOC)  # Not Normal
shapiro.test(dat$S.rar) # Not Normal
shapiro.test(dat$simpsE) # Normal
shapiro.test(dat$S.res) # Normal

# Without Pony or Lily
shapiro.test(dat$DOC[dat$DOC < 10]) # Normal
shapiro.test(dat$S.rar[dat$DOC < 10]) # Normal

# Transform DOC and S.rar with Box-Cox
D.power <- powerTransform(dat$DOC)
S.power <- powerTransform(dat$S.rar)
dat$DOC.t <- as.numeric(scale(bcPower(dat$DOC, coef(D.power, round =F))))
dat$S.rar.t <- as.numeric(scale(bcPower(dat$S.rar, coef(S.power, round =F))))
shapiro.test(dat$DOC.t) # Normal
shapiro.test(dat$S.rar.t) # Normal

# plot(dat$S.rar.t ~ dat$S.rar)

# Resource Concentration and Diversity
mod1 <- lm(S.rar.t ~ DOC.t, data = dat)
mod2 <- lm(simpsE ~ DOC.t, data = dat)
summary(mod1);summary(mod2)

mod1b <- lm(S.rar ~ DOC, data = dat[dat$DOC < 10, ])
mod2b <- lm(simpsE ~ DOC, data = dat[dat$DOC < 10, ])
summary(mod1b);summary(mod2b)

# Resource Heterogeneity and Divesity
mod3 <- lm(S.rar.t ~ S.res, data = dat)
mod4 <- lm(simpsE ~ S.res, data = dat)
summary(mod3);summary(mod4)

# Stats
mod1.p <- round(summary(mod1)$coefficients[2,4], 3)
mod2.p <- round(summary(mod2)$coefficients[2,4], 3)
mod3.p <- round(summary(mod3)$coefficients[2,4], 3)
mod4.p <- round(summary(mod4)$coefficients[2,4], 3)

# Prediction Frames
pred.frame1 <- data.frame(DOC.t = seq(-2, 2, 0.1))
pred.frame2 <- data.frame(S.res = seq(525, 572, 1))

# Correlation Test
cor.test(~ S.res + DOC.t, data = dat)
# plot(S.res ~ DOC.t, data = dat)
```

## Figure 2: Structural Relationship Plots
```{r, results = "hide"}
png(filename="../figures/Figure2.png",
    width = 1600, height = 1600, res = 96*2, bg = "white")
par(opar)

layout(matrix(1:4, nrow = 2, byrow = F))
par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(6, 5.5, 0, 0) + 0.1)

# Resource Concentration vs Species Richness
plot(dat$S.rar.t ~ dat$DOC.t, type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(-2, 2), ylim = c(-2, 2), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod1, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod1, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$S.rar.t ~ dat$DOC.t,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topleft", legend = bquote(italic(P) == .(mod1.p)), 
       bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
# mtext("Nutrients", side = 1, line = 3, cex = 1.5)
mtext("Species Richness\n(Transformed)", side = 2, line = 3, cex = 1.5)
axis(1, lwd = 2, labels = F)
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)
#text(1.7, 1245, "Pony")
#text(1.73, 1070, "Lily")

# Resource Concentration vs Species Evenness
plot(dat$simpsE ~ dat$DOC.t, type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(-2, 2), ylim = c(0, 0.07), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod2, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod2, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$simpsE ~ dat$DOC.t,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(P) == .(mod2.p)), 
       bty = "n", cex = 1.5, inset = 0.01)
mtext("[DOC] (Transformed)", side = 1, line = 3.5, cex = 1.5)
mtext("Species Evenness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = T, cex.axis = 1.5)
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0, 0.08, 0.02)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
box(lwd = 2)

# Resource Richness vs Species Richness
plot(dat$S.rar.t ~ dat$S.res , type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(525, 572), ylim = c(-2, 2), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod3, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod3, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$S.rar.t ~ dat$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topright", legend = bquote(italic(P) == .(mod3.p)), 
       bty = "n", cex = 1.5, inset = 0.01)
# mtext("DOM Richness", side = 1, line = 3, cex = 1.5)
# mtext("Species Richness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, labels = F, las = 1)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F)
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F)
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F)
box(lwd = 2)

# Resource Richness vs Species Eveness
plot(dat$simpsE ~ dat$S.res, type = "n", 
     xlab = "", ylab = "", axes = F,
     xlim = c(525, 572), ylim = c(0, 0.07), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod4, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod4, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$simpsE ~ dat$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("topleft", legend = bquote(italic(P) == .(mod4.p)), 
       bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
mtext("DOM Richness", side = 1, line = 3.5, cex = 1.5)
# mtext("Species Evenness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, las = 1, at = c(seq(520, 570, 10)), cex.axis = 1.5)
axis(2, lwd = 2, labels = F, las = 1, at = c(seq(0, 0.08, 0.02)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.08, 0.02)))
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices

img <- readPNG("../figures/Figure2.png")
grid.raster(img)
```

## Figure S3: Structural Relationship Plots - linear
```{r, results = "hide"}
png(filename="../figures/FigureS3.png",
    width = 1600, height = 1600, res = 96*2, bg = "white")
par(opar)

layout(matrix(1:4, nrow = 2, byrow = F))
par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(6, 5.5, 0, 0) + 0.1)

# Resource Concentration vs Species Richness
plot(dat$S.rar ~ dat$DOC, type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 30), ylim = c(600, 2600), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
#add.hull(model = mod1, pred.frame = pred.frame1)
#matlines(pred.frame1, predict(mod1, interval = "c", newdata=pred.frame1),
#         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$S.rar ~ dat$DOC,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# legend("topleft", legend = bquote(italic(P) == .(mod1.p)), 
#        bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
# mtext("Nutrients", side = 1, line = 3, cex = 1.5)
mtext("Species Richness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(seq(0, 30, 10)))
axis(1, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 30, 10)))
axis(2, lwd = 2, labels = T, las = 1, cex.axis = 1.5, 
     at = seq(600, 20000, by = 400))
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 30, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, 
     at = seq(600, 20000, by = 400))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 30, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, 
     at = seq(600, 20000, by = 400))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 30, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, 
     at = seq(600, 20000, by = 400))
box(lwd = 2)
#text(1.7, 1245, "Pony")
#text(1.73, 1070, "Lily")

# Resource Concentration vs Species Evenness
plot(dat$simpsE ~ dat$DOC, type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(0, 30), ylim = c(0, 0.07), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# add.hull(model = mod2, pred.frame = pred.frame1)
# matlines(pred.frame1, predict(mod2, interval = "c", newdata=pred.frame1),
#          lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$simpsE ~ dat$DOC,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# legend("topright", legend = bquote(italic(P) == .(mod2.p)), 
#        bty = "n", cex = 1.5, inset = 0.01)
mtext(expression(paste("DOC (mg C L"^-1, ")")), side = 1, line = 3.5, cex = 1.5)
mtext("Species Evenness", side = 2, line = 4, cex = 1.5)
axis(1, lwd = 2, labels = T, cex.axis = 1.5, at = c(seq(0, 30, 10)))
axis(1, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 30, 10)))
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0, 0.06, 0.02)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 30, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 30, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 30, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

# Resource Richness vs Species Richness
plot(dat$S.rar ~ dat$S.res , type = "n",
     xlab = "", ylab = "", axes = F,
     xlim = c(525, 572), ylim = c(600, 2600), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# add.hull(model = mod3, pred.frame = pred.frame2)
# matlines(pred.frame2, predict(mod3, interval = "c", newdata=pred.frame2),
#          lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$S.rar ~ dat$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# legend("topright", legend = bquote(italic(P) == .(mod3.p)), 
#        bty = "n", cex = 1.5, inset = 0.01)
# mtext("DOM Richness", side = 1, line = 3, cex = 1.5)
# mtext("Species Richness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, labels = F, las = 1, 
     at = seq(600, 20000, by = 400))
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, 
     at = seq(600, 20000, by = 400))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, 
     at = seq(600, 20000, by = 400))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, 
     at = seq(600, 20000, by = 400))
box(lwd = 2)

# Resource Richness vs Species Eveness
plot(dat$simpsE ~ dat$S.res, type = "n", 
     xlab = "", ylab = "", axes = F,
     xlim = c(525, 572), ylim = c(0, 0.07), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# add.hull(model = mod4, pred.frame = pred.frame2)
# matlines(pred.frame2, predict(mod4, interval = "c", newdata=pred.frame2),
#          lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$simpsE ~ dat$S.res,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
# legend("topleft", legend = bquote(italic(P) == .(mod4.p)), 
#        bty = "n", cex = 1.5, inset = c(-0.05, 0.01))
mtext("DOM Richness", side = 1, line = 3.5, cex = 1.5)
# mtext("Species Evenness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, las = 1, at = c(seq(520, 570, 10)), cex.axis = 1.5)
axis(2, lwd = 2, labels = F, las = 1, at = c(seq(0, 0.06, 0.02)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices

img <- readPNG("../figures/FigureS3.png")
grid.raster(img)
```


## Figure X1: DOM Richness and Species Evenness
```{r}
png(filename="../figures/FigureX1.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(5, 5.5, 0, 0) + 0.1)

# Resource Richness vs Species Eveness
plot(dat$simpsE ~ dat$S.res,
     xlab = "", ylab = "", type = "n", axes = F,
     xlim = c(525, 572), ylim = c(0, 0.06), las = 1,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
add.hull(model = mod4, pred.frame = pred.frame2)
matlines(pred.frame2, predict(mod4, interval = "c", newdata=pred.frame2),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(dat$simpsE ~ dat$S.res,
       pch = 22, col = "black", bg = "gray", cex = 1.5, lwd = 2)
legend("topleft", legend = bquote(italic(p) == .(mod4.p)), 
       bty = "n", cex = 1.25, inset = c(-0.05, 0.01))
mtext("DOM Richness", side = 1, line = 3.5, cex = 1.5)
mtext("Species Evenness", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, las = 1, at = c(seq(520, 570, 10)), cex.axis = 1.25)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0, 0.06, 0.02)), cex.axis = 1.25)
axis(3, lwd = 2, tck = -0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(1, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
axis(3, lwd = 2, tck = 0.02, labels = F, at = c(seq(520, 570, 10)))
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0, 0.06, 0.02)))
box(lwd = 2)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices

img <- readPNG("../figures/FigureX1.png")
grid.raster(img)

```

# Beta Diversity
## Bacterial Compositional Diversity
```{r}
# Calculate Bray-Curtis 
hmwf.bray.REL <- vegdist(OTUsREL.log, method = "bray")
dis.mean <- mean(hmwf.bray.REL)

# Log-Chord Distance
hmwf.bcd.euc <- vegdist(OTUs.BCD, method = "euclidean")
mean(hmwf.bcd.euc)

# Principal Coordinates Analysis w/ BC
pcoa.rel <- cmdscale(hmwf.bray.REL, eig = TRUE, k = 3) 
explainvar1.rel <- round(pcoa.rel$eig[1] / sum(pcoa.rel$eig), 3) * 100
explainvar2.rel <- round(pcoa.rel$eig[2] / sum(pcoa.rel$eig), 3) * 100
explainvar3.rel <- round(pcoa.rel$eig[3] / sum(pcoa.rel$eig), 3) * 100
sum.eig.rel <- sum(explainvar1.rel, explainvar2.rel, explainvar3.rel)

# Principal Coordinates Analysis w/ Log-Chord
pcoa.bcd <- cmdscale(hmwf.bcd.euc, eig = TRUE, k = 3) 
explainvar1.bcd <- round(pcoa.bcd $eig[1] / sum(pcoa.bcd $eig), 3) * 100
explainvar2.bcd <- round(pcoa.bcd $eig[2] / sum(pcoa.bcd $eig), 3) * 100
explainvar3.bcd <- round(pcoa.bcd $eig[3] / sum(pcoa.bcd $eig), 3) * 100
sum.eig.bcd <- sum(explainvar1.bcd, explainvar2.bcd, explainvar3.bcd)

# OTU Scores
otu.scores <- t(cor(pcoa.rel$points,OTUsREL))
otu.scores <- as.matrix(otu.scores)[,1:2]
otu.scores <- otu.scores[abs(otu.scores[,1]) > 0.7|
                           abs(otu.scores[,2]) > 0.7,]
dim(otu.scores)
```

## Compositional Relationships (dbRDA)
```{r, warning = FALSE}
# Resource Concentration dbRDA  - OLD
hmwf.bray.REL <- vegdist(OTUsREL.log, method = "bray")
pcoa.rel <- cmdscale(hmwf.bray.REL, eig = TRUE, k = 3) 
dbRDA <- capscale(hmwf.bray.REL ~ dat$DOC.t, comm = OTUsREL.log, add = T)
anova(dbRDA, permutations = how(nperm=9999))
RsquareAdj(dbRDA)

# Resource Concentration dbRDA  - NEW
hmwf.bray.REL <- vegdist(OTUsREL.log, method = "bray")
pcoa.rel <- cmdscale(hmwf.bray.REL, eig = TRUE, k = 3) 
dbRDA <- dbrda(OTUs.BCD ~ dat$DOC.t, add = T)
anova(dbRDA, permutations = how(nperm=9999))
RsquareAdj(dbRDA)

# DOM Diversity dbRDA; using: hmwf.bray.res; pcoa.res
# Calculate Bray-Curtis 
hmwf.bray.res <- vegdist(resREL.neg, method = "bray")
hmwf.bray.res.log <- vegdist(resREL.neg.log, method = "bray")
hmwf.bcd.res <- vegdist(box.cox.chord(res.neg), method = "euclidean")
pcoa.res <- cmdscale(hmwf.bcd.res, eig = TRUE, k = 3) 


dbRDA.dom <- capscale(hmwf.bray.REL ~ pcoa.res$points, add = T)
dbRDA.dom <- dbrda(OTUs.BCD ~ pcoa.res$points[, 1:2], add = T)

anova(dbRDA.dom, permutations = how(nperm=9999))
RsquareAdj(dbRDA.dom)

cca.dom <- cca(OTUsREL.log ~ pcoa.res$points[, 2])
summary(cca.dom)
anova(cca.dom, by = "axis")



```

## Figure 3: Bacterial PCoA Plot with Env Vectors
```{r, results='hide'}
# PCoA of Active Community
bray.BAC <- vegdist(decostand(OTUsREL, "log"), "bray")
pcoa.BAC <- cmdscale(bray.BAC, k = 3, eig = T)
explainvar1 <- round(pcoa.BAC$eig[1] / sum(pcoa.BAC$eig), 3) * 100
explainvar2 <- round(pcoa.BAC$eig[2] / sum(pcoa.BAC$eig), 3) * 100

# PCoA of Resoruces
bray.RES <- vegdist(decostand(resREL.neg, "log"), "bray")
pcoa.RES <- cmdscale(bray.RES, k = 3, eig = T)

# Resource Concentrations
cons.RES <- dat$DOC.t

# Initial Plot as PNG
png(filename="../figures/Figure3.png",
    width = 1300, height = 900, res = 96*2, bg = "white")

# Define Plot Parameters
par(opar)
par(mar = c(4.75, 5, 1, 1) + 0.5)

# Initiate Plot 1
plot(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], 
     ylim = c(-0.3, 0.4), xlim = c(-0.4, 0.6), 
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     #xlab = "", ylab = "", xaxt = "n", yaxt = "n",
     pch = 22, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1, 
     axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01, 
     at = c(-0.2, 0, 0.2, 0.4))
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
  
# Add Points & Labels
points(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], pch = 22, 
       cex = 2.5, bg = "gray", lwd = 2)
#text(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2],  
#     unlist(lapply(strsplit(row.names(pcoa.BAC$points), 
#     split = "_"), "[[", 1)))

# Resource Concentration Vector
# res.con <- envfit(pcoa.BAC, cons.RES)
# con.arrows <- res.con[[1]]$arrows * 0.3
# arrows(0, 0, con.arrows[, 1], con.arrows[, 2], col = "gray10", length = 0.1, lwd = 2)
# text(con.arrows[, 1] * 1.2, con.arrows[, 2] * 1.2, "Conc.", col = "black", cex = 1)

# DOM Composition Vectors
res.com <- envfit(pcoa.BAC, pcoa.RES$points[,1:2])
com.arrows <- res.com[[1]]$arrows * 0.3
arrows(0, 0, -com.arrows[1, 1], com.arrows[1, 2], 
       col = "gray30", length = 0.1, lwd = 4)
arrows(0, 0, -com.arrows[2, 1], -com.arrows[2, 2], 
       col = "gray30", length = 0.1, lwd = 4)
text(-com.arrows[1, 1] - 0.02, com.arrows[1, 2] * 1.2, "DOM 1", 
     col = "gray40", cex = 1.25, font = 3)
text(-com.arrows[2, 1] * 1.2, com.arrows[2, 2] + 0.08, "DOM 2", 
     col = "gray40", cex = 1.25, font = 3)

text(0.48, -0.045, "Lily", col = "black", cex = 0.8)
text(0.56, 0.1, "Pony", col = "black", cex = 0.8)
text(-0.085, -0.24, "Ann", col = "black", cex = 0.8)
text(0.05, -0.145, "Canyon", col = "black", cex = 0.8)
text(-0.14, -0.08, "Howe", col = "black", cex = 0.8)
text(-0.12, -0.02, "Ives", col = "black", cex = 0.8)
text(-0.255, 0.08, "Mountain", col = "black", cex = 0.8)
text(-0.23, -0.18, "Rush", col = "black", cex = 0.8)
text(-0.235, 0.25, "Second", col = "black", cex = 0.8)
text(-0.19, 0.32, "Upper", col = "black", cex = 0.8)

# legend("bottomright", c("Resource Concentration Model", 
#                         "Resource Composition Model"),
#        lwd = 2, col = c("gray10", "gray60", "gray60"), bty = "n")

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
# ```

# ```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/Figure3.png")
grid.raster(img)
```

## Figure X2: Example
```{r}
# Initial Plot as PNG
png(filename="../figures/FigureX2.png",
    width = 1300, height = 900, res = 96*2, bg = "white")

# Define Plot Parameters
par(opar)
par(mar = c(4, 5, 1, 1) + 0.5)

plot(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], 
     ylim = c(-0.3, 0.4), xlim = c(-0.4, 0.6), 
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     #xlab = "", ylab = "", xaxt = "n", yaxt = "n",
     pch = 22, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1, 
     axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01, 
     at = c(-0.2, 0, 0.2, 0.4))
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01, 
     at = c(-0.2, 0, 0.2, 0.4))
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
  
# Add Points & Labels
points(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2], pch = 22, 
       cex = 2.5, bg = "gray", lwd = 2)
#text(pcoa.BAC$points[ ,1], pcoa.BAC$points[ ,2],  
#     unlist(lapply(strsplit(row.names(pcoa.BAC$points), 
#     split = "_"), "[[", 1)))

# Resource Concentration Vector
# res.con <- envfit(pcoa.BAC, cons.RES)
# con.arrows <- res.con[[1]]$arrows * 0.3
# arrows(0, 0, con.arrows[, 1], con.arrows[, 2], col = "gray10", length = 0.1, lwd = 2)
# text(con.arrows[, 1] * 1.2, con.arrows[, 2] * 1.2, "Conc.", col = "black", cex = 1)

text(0.48, -0.045, "Lily", col = "black", cex = 0.8)
text(0.56, 0.1, "Pony", col = "black", cex = 0.8)
text(-0.085, -0.24, "Ann", col = "black", cex = 0.8)
text(0.05, -0.145, "Canyon", col = "black", cex = 0.8)
text(-0.14, -0.08, "Howe", col = "black", cex = 0.8)
text(-0.12, -0.02, "Ives", col = "black", cex = 0.8)
text(-0.255, 0.08, "Mountain", col = "black", cex = 0.8)
text(-0.23, -0.18, "Rush", col = "black", cex = 0.8)
text(-0.235, 0.25, "Second", col = "black", cex = 0.8)
text(-0.19, 0.32, "Upper", col = "black", cex = 0.8)

# legend("bottomright", c("Resource Concentration Model", 
#                         "Resource Composition Model"),
#        lwd = 2, col = c("gray10", "gray60", "gray60"), bty = "n")

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
# ```

# ```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Diversity"}
img <- readPNG("../figures/FigureX2.png")
grid.raster(img)
```

# Generalist and Specialists Patterns
## Spatial Generalists 
```{r}
# Define generalits as those found at all sites
sp.gens <- which(colSums(OTUsPA) >= 8)
sp.gen.tax <- OTU.tax[which(OTU.tax$OTU %in% names(sp.gens)), ]
table(sp.gen.tax$Order)

# Define specialists as those found at only 2 or fewer sites
sp.spec <- which(colSums(OTUsPA) <= 5)
sp.spe.tax <- OTU.tax[which(OTU.tax$OTU %in% names(sp.spec)), ]
table(sp.spe.tax$Order)
```

## Consumer-Resource Interaction
```{r}
# Subset OTUs for most dominant
all.equal(colnames(OTUsREL), colnames(OTUsPA))
# OTUsREL.dom <- OTUsREL[,which(colSums(as.matrix(OTUsREL)) > 0.005 )]

OTUsREL.dom <- OTUsREL[,which(colSums(as.matrix(OTUsREL)) > 0.01 & 
                                colSums(OTUsPA) > 1)]
dim(OTUsREL.dom)

row.names(OTUsREL.dom) <- gsub("2012_RNA", "", row.names(OTUsREL.dom))
write.table(OTUsREL.dom, "../data/OTUsREL.subset.txt", quote = F)

# which((log10(apply(OTUsREL.dom, 2, max)) - 
#        log10(apply(OTUsREL.dom, 2, min))) > 2)

# Subset Resources for 100 most dominant
resREL.dom <- resREL.neg[,which(colSums(as.matrix(resREL.neg)) > 0.01)]
resREL.dom <- resREL.dom[,order(colSums(as.matrix(resREL.dom)), decreasing = T)[1:100]]

# Subset Resoruce for most influential
resREL.sc <- t(cor(pcoa.RES$points,resREL.neg))
resREL.sc <- as.matrix(resREL.sc)[,1:3]
resREL.sc <- resREL.sc[abs(resREL.sc[,1]) >= 0.7 | abs(resREL.sc[,2]) >= 0.7  | 
                         abs(resREL.sc[,3]) >= 0.7, ]
resREL.inf <- resREL.neg[, which(colnames(resREL.neg) %in% rownames(resREL.sc))]
dim(resREL.inf)

# Save Data
write.table(resREL.inf, "../data/ResREL.subset.txt", quote = F)

# Define Function
spear.matrix <- function(mat1 = "", mat2 = "", dim1 = "", dim2 = ""){
  mat.temp <- matrix(NA, dim1, dim2)
  row.names(mat.temp) <- colnames(mat1)
  colnames(mat.temp) <- colnames(mat2)
  mat.temp <- cor(mat1, mat2, method = "spearman")
  return(mat.temp)
}

dim1 <- dim(OTUsREL.dom)[2]
dim2 <- dim(resREL.inf)[2]

# Calculate Consumer Resource Correlations
spear.ConRes <- spear.matrix(mat1 = OTUsREL.dom, mat2 = resREL.inf, dim1, dim2)

# Isolate Relavent Interactions
spear.ConRes2 <- spear.ConRes
spear.ConRes2[which(spear.ConRes < 0.6 & spear.ConRes > -0.6)] <- 0
spear.ConRes3 <- spear.ConRes2

# Summary
str(spear.ConRes3)
sum(spear.ConRes3 <= -0.7)
sum(spear.ConRes3 >= 0.7)
pos.cor.ConRes <- which(spear.ConRes3 >= 0.7)
neg.cor.ConRes <- which(spear.ConRes3 <= -0.7)

# Significance Test
sig.test.neg <- vector("list", 1000)
sig.test.pos <- vector("list", 1000)
for (i in 1:1000) {
  # Two IndepSwap Runs
  testA <- randomizeMatrix(as.matrix(OTUsREL.dom), null.model = "independentswap")
  testB <- randomizeMatrix(as.matrix(resREL.inf), null.model = "independentswap")
  # Co-Occurence Analysis
  spear.ConRes.test <- spear.matrix(testA, testB, dim1, dim2)
  spear.ConRes2.test <- spear.ConRes.test
  spear.ConRes2.test[which(spear.ConRes.test <= 0.7 & 
                             spear.ConRes.test >= -0.7)] <- 0
  spear.ConRes3.test <- as.matrix(spear.ConRes2.test)
  sig.test.neg[[i]] <- which(spear.ConRes3.test <= -0.7)
  sig.test.pos[[i]] <- which(spear.ConRes3.test >= 0.7)
}

# False Negatives
false.neg <- which((table(unlist(sig.test.neg)) / 1000) > 0.05)
false.pos <- which((table(unlist(sig.test.pos)) / 1000) > 0.05)
weak.neg <- which((table(unlist(sig.test.neg)) / 1000) > 0.05 & 
                    (table(unlist(sig.test.neg)) / 1000) < 0.1)
weak.pos <- which((table(unlist(sig.test.pos)) / 1000) > 0.05 & 
                    (table(unlist(sig.test.pos)) / 1000) < 0.1)

length(setdiff(neg.cor.ConRes, c(false.neg, weak.neg)))
length(setdiff(pos.cor.ConRes, c(false.pos, weak.neg)))
sum(length(setdiff(neg.cor.ConRes, c(false.neg, weak.neg))), 
    length(setdiff(pos.cor.ConRes, c(false.pos, weak.neg)))) / 10000

# Remove Non Significant Interactions and Define Weak Interactions
spear.ConRes4 <- spear.ConRes3
bad.ints.neg <- sort(false.neg)
bad.ints.pos <- sort(false.pos)
for (i in 1:length(bad.ints.neg)){
  if (spear.ConRes4[bad.ints.neg[i]] < 0){
    spear.ConRes4[bad.ints.neg[i]] <- 0
  } else {}
}
for (i in 1:length(bad.ints.pos)){
  if (spear.ConRes4[bad.ints.pos[i]] > 0){
    spear.ConRes4[bad.ints.pos[i]] <- 0
  } else {}
}
weak.ints.neg <- sort(weak.neg)
weak.ints.pos <- sort(weak.pos)
for (i in 1:length(weak.ints.neg)){
  if (spear.ConRes4[weak.ints.neg[i]] < 0){
    spear.ConRes4[weak.ints.neg[i]] <- 0
  } else {}
}
for (i in 1:length(weak.ints.pos)){
  if (spear.ConRes4[weak.ints.pos[i]] > 0){
    spear.ConRes4[weak.ints.pos[i]] <- 0
  } else {}
}

# Remove Zero Sum Col and Rows
spear.ConRes5 <- spear.ConRes4[which(apply(spear.ConRes4, 1, min) < 0), 
                               which(apply(spear.ConRes4, 2, min) < 0)]

# Summary
str(spear.ConRes5)
dim(spear.ConRes5)
sum(spear.ConRes5 < -0.7)
sum(spear.ConRes5 > 0.7)
percent.total <- (sum(spear.ConRes5 <= -0.7) + sum(spear.ConRes5 >= 0.7)) / 
  (dim(spear.ConRes5)[1] * dim(spear.ConRes5)[2])
pos.cor.ConRes <- which(spear.ConRes5 >= 0.7)
neg.cor.ConRes <- which(spear.ConRes5 <= -0.7)
sum(colSums(spear.ConRes5) != 0) / dim(spear.ConRes)[2]
sum(rowSums(spear.ConRes5) != 0) / dim(spear.ConRes)[1]
sum(pos.cor.ConRes != 0)
sum(neg.cor.ConRes != 0)
```

## Resource Generalists
```{r}
ConRes.matrix <- as.matrix(spear.ConRes5)
re.gens <- rownames(ConRes.matrix)[rowSums(ConRes.matrix <= -0.7) >= 4]
re.gen.tax <- OTU.tax[which(OTU.tax$OTU %in% re.gens), ]
table(re.gen.tax$Order)

re.spec <- rownames(ConRes.matrix)[rowSums(ConRes.matrix <= -0.7) <= 2]
re.spe.tax <- OTU.tax[which(OTU.tax$OTU %in% re.spec), ]
table(re.gen.tax$Order)
```

## Figure 4: Generalists Plot
```{r}
png(filename="../figures/Figure4.png",
    width = 1000, height = 1600, res = 96*2, bg = "white")
par(opar)

layout(matrix(1:2, nrow = 2, byrow = F))
par(mar = c(0.5, 1, 1, 1) + 0.1, oma = c(5, 6, 0, 0) + 0.1)

# Spatial Generalists
#Organize Data 
per.sp.gens <- rowSums(OTUsREL[, c(sp.gens)])
all.equal(row.names(dat), gsub("2012_RNA", "", names(per.sp.gens)))

# Stats & Prediction Frames
mod1 <- lm(per.sp.gens ~ DOC.t, data = dat)
mod1.p <- round(summary(mod1)$coefficients[2,4], 3)
pred.frame1 <- data.frame(DOC.t = seq(-2, 2, 0.1))


# Initiate Plot
plot(per.sp.gens ~ dat$DOC.t, type = "n",
     xlab = "", ylab = "", xlim = c(-2, 2), ylim = c(0.45, 0.9), axes = F,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)

# Add Regression Model
add.hull(model = mod1, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod1, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(per.sp.gens ~ dat$DOC.t,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("bottomleft", legend = bquote(italic(P) == .(mod1.p)), 
       bty = "n", cex = 1.25, inset = c(-0.05, 0.01))

# Axes and Labels
#mtext("[DOC] (Transformed)", side = 1, line = 3, cex = 1.5)
mtext("Spatial Generalists\n(Proportion)", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = F, cex.axis = 1.5)
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0.1, 0.9, 0.2)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
box(lwd = 2)
abline(h = 0.5, lty = 3, lwd = 1, col = "gray50")


# Resource Generalists
#Organize Data 
per.re.gens <- rowSums(OTUsREL[, c(re.gens)])
all.equal(row.names(dat), gsub("2012_RNA", "", names(per.re.gens)))

# Stats & Prediction Frames
mod2 <- lm(per.re.gens ~ DOC.t, data = dat)
mod2.p <- round(summary(mod2)$coefficients[2,4], 3)
pred.frame1 <- data.frame(DOC.t = seq(-2, 2, 0.1))


# Initiate Plot
plot(per.re.gens ~ dat$DOC.t,# type = "n",
     xlab = "", ylab = "", xlim = c(-2, 2), ylim = c(0, 0.6), axes = F,
     pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)

# Add Regression Model
add.hull(model = mod2, pred.frame = pred.frame1)
matlines(pred.frame1, predict(mod2, interval = "c", newdata=pred.frame1),
         lty=c(2,3,3), lwd=c(4,2,2), col="black")
points(per.re.gens ~ dat$DOC.t,
       pch = 22, col = "black", bg = "gray", cex = 2, lwd = 2)
legend("bottomleft", legend = bquote(italic(P) == .(mod2.p)), 
       bty = "n", cex = 1.25, inset = c(-0.05, 0.01))

# Axes and Labels
mtext("[DOC] (Transformed)", side = 1, line = 3, cex = 1.5)
mtext("Resource Generalists\n(Proportion)", side = 2, line = 3.5, cex = 1.5)
axis(1, lwd = 2, labels = T, cex.axis = 1.5)
axis(1, lwd = 2, tck = -0.02, labels = F)
axis(2, lwd = 2, labels = T, las = 1, at = c(seq(0.1, 0.9, 0.2)), cex.axis = 1.5)
axis(3, lwd = 2, tck = -0.02, labels = F)
axis(4, lwd = 2, tck = -0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
axis(1, lwd = 2, tck = 0.02, labels = F)
axis(2, lwd = 2, tck = 0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
axis(3, lwd = 2, tck = 0.02, labels = F)
axis(4, lwd = 2, tck = 0.02, labels = F, at = c(seq(0.1, 0.9, 0.2)))
box(lwd = 2)
abline(h = 0.5, lty = 3, lwd = 1, col = "gray50")



dev.off() # this writes plot to folder
graphics.off() # shuts down open devices

img <- readPNG("../figures/Figure4.png")
grid.raster(img)


```


## Figure S4: Interaction Plot
```{r, results='hide'}
png(filename="../figures/FigureS4.png",
    width = 2400, height = 2400, res = 96*2, bg = "white")
par(opar)
# Custome Color Palette
jet.colors <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                 "#7FFF7F", "yellow", "#FF7F00", "red", 
                                 "#7F0000"))
jet.colors.W <- colorRampPalette(c("#00007F", "blue", "#007FFF", "cyan", 
                                   "white", "white", "white", "white",
                                   "yellow", "#FF7F00", "red", "#7F0000"))
ConRes.matrix <- as.matrix(spear.ConRes5)
rownames(ConRes.matrix) <- gsub("Otu.0", "OTU",rownames(ConRes.matrix))
res.order <- order(colSums(abs(ConRes.matrix) >=  0.5), decreasing = T)
cons.order <- order(rowSums(abs(ConRes.matrix) >= 0.5), decreasing = T)
heatmap.2(ConRes.matrix[cons.order, res.order], 
          col = jet.colors.W, Rowv = F, Colv = F,
          dendrogram = "none", na.rm = F, na.color = "white", trace = "none", 
          density.info = "none", key.xlab = "Interaction", key.title = "", 
          key.par=list(cex = 1, cex.lab = 1.5, mar = c(4, 4, 4, 4)), 
          cexCol = 0.5, cexRow = 0.5, main = "", 
          lhei = c(1, 5), lwid = c(1.5, 4))
mtext("Resource Availability", side = 3, line = 7, cex = 2, adj = 0.60)
#mtext("Available", side = 3, line = 0.8, cex = 1, adj = 0.2,  padj = 1)
#mtext("Restrictive", side = 3, line = 0.8, cex = 1, adj = 1, padj = 1)
mtext("Consumer Strategy", side = 2, line = -3, cex = 2, adj = 0.325)
#mtext("Generalist", side = 2, line = -5, cex = 1, adj = 1, las = 1, at = 0.90)
#mtext("Specialist", side = 2, line = -5, cex = 1, adj = 1, las = 1, at = -0.12, xpd = T)
#arrows(x0 = 0.33, y0 = 1.015, x1 = 0.83, y1 = 1.015, length = 0.1, angle = 45, lwd = 3, xpd = T)
#arrows(x0 = 0.1, y0 = 0.85, x1 = 0.1, y1 = -0.08, length = 0.1, angle = 45, lwd = 3, xpd = T)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
# ```

# ```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Interaction Heatmap"}
img <- readPNG("../figures/FigureS4.png")
grid.raster(img)
```

## Figure S5: Example Responders
```{r, results='hide'}
png(filename="../figures/FigureS5.png",
    width = 1600, height = 900, res = 96*2)
par(opar)

# Example Taxa
examples <- ConRes.matrix[cons.order, res.order]
otu.spread <- which((log10(apply(abundancesR, 2, max)) - 
         log10(apply(abundancesR, 2, min))) > 2)
#examples[which(row.names(examples) %in% names(otu.spread)), ]
abundancesR <- OTUsREL.dom
colnames(abundancesR) <- gsub("Otu.0", "OTU",colnames(abundancesR))

# Set Plot Parameters 
layout(matrix(c(1:2), 1, 2))
par(mar = c(1, 2, 0, 0) + 0.5, oma = c(4, 3, 0.5, 0.5))

# Negative Example

OTU.neg <- abundancesR[, which(colnames(abundancesR) == "OTU024")]
DOM.neg <- resREL.inf[, which(colnames(resREL.inf) == "C52")]
plot(OTU.neg * 100, DOM.neg * 1000, pch = 22, bg = "gray", cex = 2, lwd = 2,
     xlim = c(0, 3.5), ylim = c(0.8, 3.5), las = 1, cex.lab = 1.5, 
     xlab = "", ylab = "", axes = F)
cor(OTU.neg, DOM.neg, method = "spearman")
lines(stats::lowess(DOM.neg * 1000 ~ OTU.neg * 100), lwd = 4, lty = 2)
axis(side=1, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 0.8, las = 1)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = T, cex.axis = 0.8, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
box(lwd = 2)

# Positive Example
# examples[which(row.names(examples) %in% names(otu.spread)), which(colnames(examples) == "C789")]
OTU.pos <- abundancesR[, which(colnames(abundancesR) == "OTU070")]
DOM.pos <- resREL.inf[, which(colnames(resREL.inf) == "C789")]
plot(OTU.pos * 100, DOM.pos * 1000, pch = 22, bg = "gray", cex = 2, lwd = 2,
     xlim = c(0, 1.8), ylim = c(0, 1.15), las = 1, cex.lab = 1.5,
     xlab = "", ylab = "", axes = F)
cor(OTU.pos, DOM.pos, method = "spearman")
lines(stats::lowess(DOM.pos * 1000 ~ OTU.pos * 100), lwd = 4, lty = 2)
axis(side=1, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 0.8, las = 1)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = T, cex.axis = 0.8, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
box(lwd = 2)

mtext("Species Abundance (%)", 1, line = 2, cex = 1.25, outer = T)
mtext("Resource Abundance (\u2030)", 2, line = 1, cex = 1.25, outer = T)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 

img <- readPNG("../figures/FigureS5.png")
grid.raster(img)
```


## Resource Generalists
```{r}
per.gens <- rowSums(OTUsREL[, c(generalists)])
all.equal(row.names(dat), gsub("2012_RNA", "", names(per.gens)))
plot(per.gens ~ dat$DOC.t)
abline(h = 0.5)

per.spes <- rowSums(OTUsREL[, c(specialists)])
all.equal(row.names(dat), gsub("2012_RNA", "", names(per.spes)))
plot(per.spes ~ dat$DOC.t)

length(generalists)

abundancesR <- OTUsREL
colnames(abundancesR) <- gsub("Otu.0", "OTU",colnames(abundancesR))
rownames(abundancesR) <- gsub("2012_RNA", "", rownames(abundancesR))

spec.matrix <- matrix(NA, nrow = 10, ncol = 6)
colnames(spec.matrix) <- c("Total.Rel.Gen", "Active.Rel.Gen", "Total.Num.Gen", 
                           "Total.Rel.Spe", "Active.Rel.Spe", "Total.Num.Spe")
rownames(spec.matrix) <- rownames(abundancesD)

for (i in 1:(dim(spec.matrix)[1])){
  temp.gensT <- abundancesD[i, colnames(abundancesD) %in% generalists]
  temp.gensA <- abundancesR[i, colnames(abundancesR) %in% generalists]
  temp.specT <- abundancesD[i, colnames(abundancesD) %in% specialists]
  temp.specA <- abundancesR[i, colnames(abundancesR) %in% specialists]
  spec.matrix[i,1] <- round(sum(temp.gensT), 3)
  spec.matrix[i,2] <- round(sum(temp.gensA), 3)
  spec.matrix[i,3] <- sum(temp.gensT > 0)
  spec.matrix[i,4] <- round(sum(temp.specT), 3)
  spec.matrix[i,5] <- round(sum(temp.specA), 3)
  spec.matrix[i,6] <- sum(temp.specA > 0)
}


t.test(spec.matrix[, 2], spec.matrix[,4], var.equal = T)


#```


# Generalist:Specialists Ratio Plot
#```{r, results='hide'}
png(filename="../figures/Figure4_old.png",
    width = 1600, height = 1600, res = 96*2)
par(opar)
layout(matrix(c(1,2), 2, 1))
par(mar = c(5, 5, 0, 0) + 0.5, oma = c(0.5, 1, 1, 1))

labs <- c("Ann", "Canyon", "Howe", "Ives", "Lily", "Mountain", "Pony", "Rush",
         "Second\nPine","Upper\nPine")


# Initiate Plot
plot(spec.matrix[,2], type = "n", 
     xlim = c(0.75, 10.25), ylim = c(0, 0.8),
     xaxt="n", yaxt="n", xlab = "", ylab = "")
points(seq(0.9, 9.9, 1), spec.matrix[,2], pch = 22, cex = 2,
       bg = "gray80", lwd = 2)
#points(seq(1.1, 10.1, 1), spec.matrix[,2], pch = 24, cex = 2,
#       bg = "cornflowerblue", lwd = 2)
points(seq(0.9, 9.9, 1), spec.matrix[,5], pch = 24, cex = 2,
       bg = "gray80", lwd = 2)
#points(seq(1.1, 10.1, 1), spec.matrix[,5], pch = 24, cex = 2,
#       bg = "wheat3", lwd = 2)

abline(h = 0.5, lwd = 2, lty = 3)
text(0.85, 0.45, "50%", cex = 1.5)
axis(side=1, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1, at = 1:10)
axis(side=1, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1, at = 1:10)
axis(side=2, lwd.ticks = 2, labels = T, cex.axis = 1.2, las = 1)
axis(side=2, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1, at = 1:10)
axis(side=3, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1, at = 1:10)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=0.01, labels = F, cex.axis = 1)

mtext(side = 1, text = labs, line = 1, at = seq(1:10), padj = 0.5, cex = 0.8)
mtext(side = 1, text = "Lake", line = 3, cex = 1.5)
mtext(side = 2, "Proportion of Community", line = 3.5, cex = 1.5)

box(lwd = 2)

# Add Legend
#par(mar = c(0, 0, 0, 0) )
#plot.new()

legend("topright", legend = c("Generalists", "Specialists"),
       pch = c(22, 24), pt.lwd = 2,
       pt.bg = "gray80",
       bty = "n", pt.cex = 1.25, cex = 1, ncol = 2, y.intersp = 1.5)



generalism <- matrix(NA, 10, 10)
colnames(generalism) <- c(1:10)
rownames(generalism) <- rownames(abundancesR)
for (j in c(1:9)){
  for (i in 1:dim(generalism)[1]){
    generalism.temp <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) <= j]
    generalism.temp.2 <- abundancesR[i, colnames(abundancesR) %in% generalism.temp]
    generalism[i,j] <- round(sum(generalism.temp.2), 3)
  }
}
for (i in 1:dim(generalism)[1]){
  generalism.temp <- rownames(ConRes.matrix)[rowSums(ConRes.matrix < -0.7) <= 30]
  generalism.temp.2 <- abundancesR[i, colnames(abundancesR) %in% generalism.temp]
  generalism[i,10] <- round(sum(generalism.temp.2), 3)
}

plot(generalism[1,], type = 'n', las = 1, axes = F,
     xlim = c(0.5,10.5), ylim = c(0,0.9),
     ylab = "",
     xlab = "")
for (i in 1:10){
  points(generalism[i, ], pch = 22, bg = "gray", lwd = 2, cex = 1.5)
}

abline(v = 2.5, lty = 2, lwd = 2)
abline(v = 6.5, lty = 2, lwd = 2)
abline(h = 0.5, lwd = 2, lty = 3)
abline(h = 0.5, lwd = 2, lty = 3)

text(2.35, 0.85, "*", cex = 2)
text(6.5, 0.85, "**", cex = 2)
text(0.6, 0.55, "50%", cex = 1.5)

axis(side=1, lwd.ticks = 2, tck=-0.04, labels = c("2", "4", "6", "8", "10+"), 
     at = c(seq(2,10,2)), cex.axis = 1, las = 1)
axis(side=2, lwd.ticks = 2, tck=-0.04, labels = T, cex.axis = 1, las = 1)

axis(side=1, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=2, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=3, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck=-0.02, labels = F, cex.axis = 1)
axis(side=4, lwd.ticks = 2, tck= 0.01, labels = F, cex.axis = 1)

mtext(side = 1, "Number of Resources", cex = 1.5, line = 3)
mtext(side = 2, "Cumulative Proportion", cex = 1.5, line = 3.5)

box(lwd = 2)



dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Interaction Heatmap"}
img <- readPNG("../figures/Figure4_old.png")
grid.raster(img)
```

# Generalist:Specialists Ratio Plot: Sensitivity
```{r, results='hide'}
png(filename="../figures/Figure4B.png",
    width = 1200, height =800, res = 96*2)
par(opar)


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices 
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Generalists"}
img <- readPNG("../figures/Figure4B.png")
grid.raster(img)
```

# Who are the Generalists and Specialists
```{r}
length(specialists)
length(generalists)

generalists
OTU.tax[,1] <- gsub("Otu000", "OTU",OTU.tax[,1])
Gen.Tax <- OTU.tax[which(OTU.tax[,1] %in% generalists),]
Spe.Tax <- OTU.tax[which(OTU.tax[,1] %in% specialists),]

Gen.Tax.Class <- Gen.Tax$Class
Spe.Tax.Class <- Spe.Tax$Class
Gen.Tax.Gen <- Gen.Tax$Genus
Spe.Tax.Gen <- Spe.Tax$Genus

unique(Gen.Tax.Gen)
unique(Spe.Tax.Gen)

table(Gen.Tax.Gen)
table(Spe.Tax.Gen)

setdiff(unique(Gen.Tax.Gen), unique(Spe.Tax.Gen))
setdiff(unique(Spe.Tax.Gen), unique(Gen.Tax.Gen))
intersect(unique(Gen.Tax.Gen), unique(Spe.Tax.Gen))

```


# Consumer-Resource Feedbacks
## Graph Analysis Plot
```{r, results='hide'}
# Reorganize Data
feedbacks <- ConRes.matrix
str(feedbacks)
bacs <- dim(feedbacks)[1]
ress <- dim(feedbacks)[2]
bac <- rep(rownames(feedbacks), ress)
res <- rep(colnames(feedbacks), each = bacs)
int <- as.numeric(feedbacks[, 1])
for (i in 2:ress){
  int = append(int, as.numeric(feedbacks[, i]))
}
bac2 <- bac 
bac2 <- gsub("Otu000", "O", bac2)
graph.list.full <- data.frame(bac2, res, int)

png(filename="../figures/Figure5.png",
    width = 1800, height = 1800, res = 96*2, bg = "white")
par(opar)

# Plot Settings
layout(matrix(1:4, ncol = 2, byrow = T))
par(mar = c(1, 1, 2, 1), oma = c(1, 1, 2, 1))

# Positive Network
graph.list <- graph.list.full[graph.list.full$int > 0.86, ]
hmwf.network <- graph.data.frame(graph.list, directed=F)
hmwf.network <- simplify(hmwf.network)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 
E(hmwf.network)$color <- "red"

plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Production Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

# Negative Network
graph.list <- graph.list.full[graph.list.full$int < -0.86, ]
hmwf.network <- graph.data.frame(graph.list, directed=F)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 
E(hmwf.network)$color <- "blue"
plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Consumption Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

# Feedback Network
graph.list <- graph.list.full[abs(graph.list.full$int) > 0.87, ]

graph.list <- graph.list.full[union(which(graph.list.full$bac2 %in% 
                                      c("OTU006", "OTU020", 
                                        "OTU001", "OTU166",
                                        "OTU008")),
                                    which(graph.list.full$res %in%
                                      c("C551", "C3", "C86", "C652",
                                        "C187"))), ] 

graph.list <- graph.list[abs(graph.list$int) > 0.8 , ]

hmwf.network <- graph.data.frame(graph.list, directed=F)
bets <- betweenness(hmwf.network)
degs <- degree(hmwf.network)
mean(bets[grep("O", names(bets))])
mean(bets[grep("C", names(bets))])
mean(degs[grep("O", names(degs))])
mean(degs[grep("C", names(degs))])
mean(table(t(graph.list[, 1]))[table(t(graph.list[, 1])) > 0 ])
mean(table(t(graph.list[, 2]))[table(t(graph.list[, 2])) > 0 ])


# Plot
V(hmwf.network)$color <- V(hmwf.network)$name
V(hmwf.network)$color[grepl("O",V(hmwf.network)$color)] <- "cornflowerblue"
V(hmwf.network)$color[grepl("C",V(hmwf.network)$color)] <- "wheat3" 

E(hmwf.network)$color <- NA
E(hmwf.network)$color[which(graph.list$int < 0)] <- "blue"
E(hmwf.network)$color[which(graph.list$int > 0)] <- "red" 

plot(hmwf.network, layout=layout.fruchterman.reingold, 
     main='Feedback Network', vertex.label.dist=0,
     vertex.label.color='black', vertex.label.cex=0.5,
     edge.width = 4)

plot.new()

legend(0.1, 0.75, c("Bacteria", "DOM", "Neg. Interaction", "Pos. Interaction"), 
       pch = c(21, 21, 0, 0), lty = c(0, 0, 1, 1), lwd = c(0, 0, 3, 3),
       pt.bg = c("cornflowerblue", "wheat3", "white", "white"), 
       col = c("black", "black", "blue", "red"), pt.lwd = 1, pt.cex = c(3, 3, 0.1, 0.1),
       bty = "n", y.intersp = 2, xjust = 0, adj = c(0, 0.5))


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
```

```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="Networks"}
img <- readPNG("../figures/Figure5.png")
grid.raster(img)
```


# Supplemental
## Supplemental Figure 1: System Map
```{r fig.width=7, fig.height=3.5,echo=FALSE,fig.cap="Study System Map"}
img <- readPNG("../figures/SuppFigure1.png")
grid.raster(img)
```

## Supplemental Figure 2: Organic Matter Ordination Figure
```{r, results='hide'}
design2 <- design[design$Molecule == "DNA" & design$Year == "2012", ]
# Custom palette
palette(rainbow_hcl(10, c = 80, l = 60))
lake.col <- rep(NA, length(unique(design2$Lake)))
names(lake.col) <- unique(design2$Lake)
lake.col <- as.numeric(factor(design2$Lake))

png(filename="../figures/SuppFigure2.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

# Define Plot Parameters
layout(matrix(1))
par(mar = c(5, 5, 1, 1) + 0.5)

plot(pcoa.res$points[ ,1], pcoa.res$points[ ,2],
     ylim = c(-0.25, 0.3), xlim = c(-0.25, 0.3),
     xlab = paste("PCoA 1 (", explainvar1.res, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2.res, "%)", sep = ""),
     #xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 17, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1,
     axes = FALSE)

  # Add Axes
  axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  abline(h = 0, v = 0, lty = 3)
  box(lwd = 2)

# Add DOM Scores
arrows(0, 0, dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2, col = "red", length = 0.1)
text(dom.scores[, 1] * 0.2, dom.scores[, 2] * 0.2, rownames(dom.scores), col = "red", cex = 0.5)

# Add Points & Labels
points(pcoa.res$points[ ,1], pcoa.res$points[ ,2], pch = 15,
       cex = 4, bg = "gray", col = lake.col)
text(pcoa.res$points[ ,1]  + c(0, 0, 0, 0, 0.02, 0, 0, 0, 0, 0),
     pcoa.res$points[ ,2] + c(0, 0, 0, 0, 0.02, 0, 0, 0, 0, 0), 
     labels = row.names(pcoa.res$points))


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="PCoA Plot Resources"}
img <- readPNG("../figures/SuppFigure2.png")
grid.raster(img)
```

## Supplemental Figure 2: Organic Matter Ordination Figure
```{r, results='hide'}
design2 <- design[design$Molecule == "DNA" & design$Year == "2012", ]
# Custom palette
palette(rainbow_hcl(10, c = 80, l = 60))
lake.col <- rep(NA, length(unique(design2$Lake)))
names(lake.col) <- unique(design2$Lake)
lake.col <- as.numeric(factor(design2$Lake))

png(filename="../figures/SuppFigure2B.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

# Define Plot Parameters
layout(matrix(1))
par(mar = c(5, 5, 1, 1) + 0.5)

plot(pcoa.res$points[ ,1], pcoa.res$points[ ,2],
     ylim = c(-0.25, 0.3), xlim = c(-0.25, 0.3),
     xlab = paste("PCoA 1 (", explainvar1.res, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2.res, "%)", sep = ""),
     #xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 17, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1,
     axes = FALSE)

  # Add Axes
  axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  abline(h = 0, v = 0, lty = 3)
  box(lwd = 2)

# Add Points & Labels
points(pcoa.res$points[ ,1], pcoa.res$points[ ,2], pch = 15,
       cex = 4, bg = "gray", col = lake.col)
text(pcoa.res$points[ ,1]  + c(0, 0, 0, 0, 0.02, 0, 0, 0, 0, 0),
     pcoa.res$points[ ,2] + c(0, 0, 0, 0, 0.02, 0, 0, 0, 0, 0), 
     labels = row.names(pcoa.res$points))


dev.off() # this writes plot to folder
graphics.off() # shuts down open devices
#```

#```{r fig.width=4, fig.height=4,echo=FALSE,fig.cap="PCoA Plot Resources"}
img <- readPNG("../figures/SuppFigure2B.png")
grid.raster(img)
```


# Feature Selection
```{r}
# Old Method (correlations)

library(randomForest)

# Random Forest Supervised Learning
resREL.neg
res.rf <- randomForest(lake.env$DOC ~ ., data = res.neg, importance = T, proximity = T)

# Unsupervised Random Forest
res.rf <- randomForest(res.neg, importance = T, proximity = T, ntree = 1000)
print(res.rf)
round(importance(res.rf, scale = F), 6)

varImpPlot(res.rf)

plot(res.rf$importance)


cor.mat <- cor(resREL.neg)
highlyCor <- caret::findCorrelation(cor.mat, cutoff = 0.95, names = F)
highlyCor
highlyCor.names <- caret::findCorrelation(cor.mat, cutoff = 0.95, names = T)
highlyCor.names

# Youd use the largest ion for each compound cluster as a proxy for size, and short retention time = more polar, long retention time = more aliphatic.


hist((neg.meta$Rt), breaks = 50)
hist((neg.meta$Rt[-c(highlyCor)]), breaks = 50)

hist(log10(neg.meta$mz.max), breaks = 50)
hist(log10(neg.meta$mz.max[-c(highlyCor)]), breaks = 50)

cor.mat[6,]


heatmap(as.matrix(resREL.neg.log), 
        distfun = function(x) vegdist(x, method = "bray"))

cor.mat <- cor(resREL.neg.log)
highlyCor <- caret::findCorrelation(cor.mat, cutoff = 0.95, names = F)
highlyCor

cor.mat[highlyCor, ]

heatmap(as.matrix(resREL.neg.log)[, -c(highlyCor)], 
        distfun = function(x) vegdist(x, method = "bray"))


heatmap(as.matrix(resREL.neg.log)[, -c(highlyCor)])

res.Cluster <- kmeans(t(resREL.neg.log), 4)


library("NbClust")
nc <- NbClust(t(resREL.neg), min.nc = 10, max.nc = 50, method = "kmeans")
table(nc$Best.nc[1,])


fit.km <- kmeans(t(resREL.neg.log), 10, nstart = 25)



```


# DOM Ordination by Molecule
```{r}
png(filename="../figures/Supp_DOM.png",
    width = 900, height = 900, res = 96*2, bg = "white")
par(opar)

# Define Plot Parameters
layout(matrix(1))
par(mar = c(5, 5, 1, 1) + 0.5)


# Calculate DOM distance
res.Cor <- cor(resREL.neg)
res.Dis <- 1 - res.Cor

# Cluster Groups
res.Cluster <- kmeans(t(resREL.neg.log), 10)

res.pcoa <- cmdscale(res.Dis, k = 2, eig = T)
explainvar1 <- round(res.pcoa$eig[1] / sum(res.pcoa$eig), 3) * 100
explainvar2 <- round(rse.pcoa$eig[2] / sum(res.pcoa$eig), 3) * 100

plot(res.pcoa$points[, 1], res.pcoa$points[, 2], 
     xlim =c(-1, 1.2), ylim = c(-1.5, 1), 
     xlab = paste("PCoA 1 (", explainvar1.res, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2.res, "%)", sep = ""),
     xaxt = "n", yaxt = "n",
     pch = 17, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1,
     axes = FALSE)

  # Add Axes
  axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1, las = 1)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
  axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.02)
  abline(h = 0, v = 0, lty = 3)
  box(lwd = 2)
  
  # Add Points
  points(res.pcoa$points[ ,1], res.pcoa$points[ ,2], pch = 22, 
       cex = 1, bg = "gray", lwd = 2)
  
  #points(res.pcoa$points[ ,1], res.pcoa$points[ ,2], pch = 22, 
  #     cex = 1, bg = res.Cluster$cluster, lwd = 2)
  
  #ordihull(res.pcoa, res.Cluster$cluster, lwd = 2, lty = 2, col = "red")
  
  # Add Vectors
  all.equal(neg.meta$Name, colnames(res.Dis))
  res.fit <- envfit(res.pcoa, neg.meta[, 2:3])
  con.arrows <- res.fit[[1]]$arrows * 1.1
  arrows(0, 0, con.arrows[, 1], con.arrows[, 2], 
         col = "red", length = 0.1, lwd = 3)
  text(con.arrows[, 1] * 1.2, con.arrows[, 2] * 1.2, 
       rownames(con.arrows), col = "black", cex = 1)

dev.off() # this writes plot to folder
graphics.off() # shuts down open devices

img <- readPNG("../figures/Supp_DOM.png")
grid.raster(img)



```

# Positive Ionization of Resources
```{r}
resource.pos <- "../data/SpecAbundAvePos.csv"

res.pos.in <- read.csv(resource.pos, header=T, row.names=1)
rownames(res.pos.in) <- c("Ann", "blank", "CanyonChemo", "Canyon", "CanyonHypo",
                      "CanyonI", "CanyonII", "CanyonIII", "CanyonIV", "Howe",
                      "Ives", "Jordan", "Lily", "Mountain", "Pony", "Rush",
                      "SecondPine", "UpperPine")

blank.pos  <- unlist(res.pos.in["blank", ])

res.hmwf.pos <- res.pos.in[-c(which(rownames(res.pos.in) %in% 
                            c("blank", "CanyonChemo", 
                              "CanyonHypo", "CanyonI", "CanyonII",
                              "CanyonIII", "CanyonIV", "Jordan"))), ]

for (i in 1:dim(res.hmwf.pos)[1]){
  res.hmwf.pos[i, ] <- res.hmwf.pos[i, ] - blank.pos * 1.1
}

res.hmwf.pos[res.hmwf.pos < 50] <- 0
res.hmwf.pos <- res.hmwf.pos[,colSums(res.hmwf.pos) > 0]
res.pos <- res.hmwf.pos[order(rownames(res.hmwf.pos)), ]

# Sequencing Coverage
coverage <- data.frame(Neg = rowSums(res.neg), Pos = rowSums(res.pos))
resources <- data.frame(Neg = dim(res.neg)[2], Pos = dim(res.pos)[2])

# Calculate Relative Abundance
resREL.pos <- res.pos
for(i in 1:dim(res.pos)[1]){
  resREL.pos[i,] <- res.pos[i,]/sum(res.pos[i,])
}

# Log Transform Relative Resource Abundance
resREL.pos.log <- suppressWarnings(decostand(resREL.pos, method="log"))

# Load Meta Data
x <- scan("../data/data_20151106/pos/spectra/MarioAquaticPos.mspLib", what="", sep="\n")
ind.n <- grep("Name:", x)
pos.meta <- data.frame(matrix(NA, nrow = length(ind.n), ncol = 3))
colnames(pos.meta) <- c("Name", "Rt", "mz.max")

for (i in 1:length(ind.n)){
  pos.meta[i, 1] <- unlist(strsplit(x[ind.n[i]], ": "))[2]
  temp.comment <- unlist(strsplit(x[ind.n[i] + 12], " "))
  pos.meta[i, 2] <- as.numeric(gsub("Rt=", "", 
                                    temp.comment[grep("Rt=", temp.comment)]))
  temp.peaks <- unlist(strsplit(x[ind.n[i] + 14], " "))
  temp.mz <- as.numeric(temp.peaks[seq(1, length(temp.peaks), by = 2)])
  temp.intensity <- as.numeric(temp.peaks[seq(2, length(temp.peaks), by = 2)])
  pos.meta[i, 3] <- max(temp.mz)
}

pos.meta <- pos.meta[match(colnames(resREL.pos), pos.meta$Name), ]
```

## DOM Scores with positive ionization
```{r}
# Calculate Bray-Curtis 
hmwf.bray.res.pos <- vegdist(resREL.pos, method = "bray")
# hmwf.bray.res <- vegdist(resREL.log, method = "bray")

dis.mean <- mean(hmwf.bray.res.pos)

# Principal Coordinates Analysis
pcoa.res.pos <- cmdscale(hmwf.bray.res.pos, eig = TRUE, k = 3) 
explainvar1.res <- round(pcoa.res.pos$eig[1] / sum(pcoa.res.pos$eig), 3) * 100
explainvar2.res <- round(pcoa.res.pos$eig[2] / sum(pcoa.res.pos$eig), 3) * 100
explainvar3.res <- round(pcoa.res.pos$eig[3] / sum(pcoa.res.pos$eig), 3) * 100
sum.eig.res <- sum(explainvar1.res, explainvar2.res, explainvar3.res)

# DOM Scores
dom.scores.pos <- t(cor(pcoa.res.pos$points,resREL.pos, method = "spearman"))
dom.scores.pos <- as.matrix(dom.scores.pos)[,1:3]
dom.scores.pos <- dom.scores.pos[abs(dom.scores.pos[,1]) > 0.7 | 
                         abs(dom.scores.pos[,2]) > 0.7| 
                         abs(dom.scores.pos[,3]) > 0.7, ]

dom.scores.pos <- as.data.frame(dom.scores.pos)
dom.scores.pos[, 4:5] <- NA
colnames(dom.scores.pos) <- c("Axis_1", "Axis_2", "Axis_3", "Rt", "mz")

for (i in 1:dim(dom.scores.pos)[1]){
  temp <- which(pos.meta$Name == rownames(dom.scores.pos)[i])
  dom.scores.pos[i, 4] <- as.numeric(pos.meta$Rt[temp[1]])
  dom.scores.pos[i, 5] <- as.numeric(pos.meta$mz.max[temp[1]])
}

write.table(round(dom.scores.pos, 3), file = "../data/HMWF_DOM_POS.txt", 
            sep = "\t", quote = F, col.names = NA)


```
